<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta name="copyright" content="(C) Copyright 2023" />
<meta name="DC.rights.owner" content="(C) Copyright 2023" />
<meta name="generator" content="DITA-OT" /><meta name="DC.type" content="concept" />
<meta name="DC.title" content="Sample commands" />
<meta name="prodname" content="Nokia Converged Charging" />
<meta name="version" content="Release 23.8" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="Bookmark3" />
<link rel="stylesheet" type="text/css" href="../../web/css/commonltr.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/styles.min.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/common-extended.css" /><title>Sample commands</title>
<script src="../web/js/nswtc.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
<script src="../../web/css/../js/script.min.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
</head>
<body id="Bookmark3">
<div class="header"><div id="feedback-link-placeholder" class="feedback-link"></div><hr /></div><h1 class="title topictitle1" id="ariaid-title1">Sample commands</h1>
<div class="body conbody">
    <p class="p">These are some examples of the commands to use when performing the steps throughout this
      section.</p>

    <div class="section" id="Bookmark3__Bookmark4"><h2 class="title sectiontitle">Disable MariaDB replication</h2>
      <p class="p">This example command must be issued on each maxscale pod.</p>

      <pre class="pre codeblock"><code>kubectl -n sm exec ckey-cmdb-maxscale-0 --container maxscale -- bash -c '/usr/bin/maxscale_adm --disable --stop-slave '</code></pre>
    </div>

    <div class="section" id="Bookmark3__Bookmark5"><h2 class="title sectiontitle">Re-enable MariaDB replication</h2>
      <pre class="pre codeblock"><code>kubectl -n sm exec ckey-cmdb-maxscale-0 --container maxscale -- bash -c
      '/usr/bin/maxscale_adm --enable '.</code></pre>
    </div>

    <div class="section" id="Bookmark3__Bookmark6"><h2 class="title sectiontitle">Perform a MariaDB backup</h2>
      
      <pre class="pre codeblock"><code>kubectl -n sm exec ckey-cmdb-mariadb-0 --container mariadb -- bash -c
      '/usr/bin/mariadb_db_backup --backup --file /mariadb/backup/dc1-backup.tgz'</code></pre>
      <p class="p">Then copy the tgz file to the control node:</p>

      <pre class="pre codeblock"><code>kubectl -n sm cp ckey-cmdb-mariadb-0:/mariadb/backup/dc1-backup.tgz ./dc1-backup.tgz --container mariadb</code></pre>
    </div>

    <div class="section" id="Bookmark3__Bookmark7"><h2 class="title sectiontitle">Restore the MariaDB backup on the target system</h2>
      
      <p class="p">Make the backup tgz file available on the control node of the target system, then copy it
        to each MariaDB pod:</p>

      <pre class="pre codeblock"><code>kubectl -n sm cp dc1-backup.tgz ckey-cmdb-mariadb-0:/mariadb/backup/ --container mariadb</code></pre>
      <p class="p">Then restore the backup, on each MariaDB pod:</p>

      <pre class="pre codeblock"><code>kubectl -n sm exec ckey-cmdb-mariadb-0 --container mariadb -- bash -c
        '/usr/bin/mariadb_db_backup --restore --file /mariadb/backup/dc1-backup.tgz '</code></pre>
    </div>

    <div class="section" id="Bookmark3__Bookmark8"><h2 class="title sectiontitle">Restart CKEY pods</h2>
      
      <pre class="pre codeblock"><code>kubectl -n sm delete po -l "app=ckey"</code></pre>
    </div>

    <div class="section" id="Bookmark3__Bookmark9"><h2 class="title sectiontitle">Scale CKEY pods down to 0</h2>
      
      <pre class="pre codeblock"><code>kubectl -n sm scale sts ckey-ckey --replicas=0 // ckey-ckey is the name of the StatefulSet</code></pre>
    </div>

    <div class="section" id="Bookmark3__Bookmark10"><h2 class="title sectiontitle">Scale CKEY pods up to 2</h2>
      
      <pre class="pre codeblock"><code>kubectl -n sm scale sts ckey-ckey --replicas=2 // ckey-ckey is the name of the StatefulSet</code></pre>
    </div>

    <div class="section" id="Bookmark3__Bookmark11"><h2 class="title sectiontitle">Verify MariaDB replication status</h2>
      
      <pre class="pre codeblock"><code>kubectl exec -n sm -it ckey-cmdb-maxscale-0 -c maxscale -- maxscale_adm --list-servers --all</code></pre>
      <pre class="pre codeblock"><code>This is an example of the output showing the remote datacenter named "sm2" is up and running. Their GTIDs are the same i.e they are in sync wrt replication.
DATACENTER: localhost (Domain: 1)
      Server                            IP:Port                      Server ID          GTID                            Status                
-------------------  ----------------------------------------------  ---------  ---------------------  -----------------------------------------
ckey-cmdb-mariadb-0  ckey-cmdb-mariadb-0.sm1.svc.cluster.local:3306       1000  1-1000-1009,2-2000-50  Master, Slave of External Server, Running
ckey-cmdb-mariadb-2  ckey-cmdb-mariadb-2.sm1.svc.cluster.local:3306       1002  1-1000-1009,2-2000-50  Slave, Running                         
ckey-cmdb-mariadb-1  ckey-cmdb-mariadb-1.sm1.svc.cluster.local:3306       1001  1-1000-1009,2-2000-50  Slave, Running                         
DATACENTER: sm2 (Domain: 2)
      Server                            IP:Port                      Server ID          GTID                            Status                
-------------------  ----------------------------------------------  ---------  ---------------------  -----------------------------------------
ckey-cmdb-mariadb-1  ckey-cmdb-mariadb-1.sm2.svc.cluster.local:3306       2001  1-1000-1009,2-2000-50  Slave, Running                         
ckey-cmdb-mariadb-0  ckey-cmdb-mariadb-0.sm2.svc.cluster.local:3306       2000  1-1000-1009,2-2000-50  Master, Slave of External Server, Running
ckey-cmdb-mariadb-2  ckey-cmdb-mariadb-2.sm2.svc.cluster.local:3306       2002  1-1000-1009,2-2000-50  Slave, Running</code></pre>
      <pre class="pre codeblock"><code>kubectl -n sm exec ckey-cmdb-mariadb-0 --container mariadb -- mariadb_adm --replication-status</code></pre>
      <pre class="pre codeblock"><code>This is an example of the output showing a slave external status when replication is working successfully:
SLAVE (External) STATUS    site4-nc0810.dyn.nesc.nokia.net
------------------------- -----------------------------------
Connection Name: sm1
Master Host: site1-nc0327.dyn.nesc.nokia.net
Slave IO Running: Yes
Slave SQL Running: Yes
Slave IO File: ckey-cmdb-mariadb-0-bin.000001
Slave IO Position: 5616349
Slave SQL File: ckey-cmdb-mariadb-0-bin.000001
Slave SQL Position: 5616349
Slave GTID Position: 1-1000-3132,4-4002-2432,3-3000-2400
If you see something like the following in the output, indicating that the slave on Site 4 (site4-nc0810.dyn.nesc.nokia.net) is not running, then you have to restart the maxscale pods on Site 4.
SLAVE (External) STATUS    site4-nc0810.dyn.nesc.nokia.net
-------------------------  -----------------------------------
Connection Name:           sm1
Master Host:               site1-nc0327.dyn.nesc.nokia.net
Slave IO Running:          No
Slave SQL Running:         Yes
Slave IO File:
Slave IO Position:         4
Slave SQL File:
Slave SQL Position:        4
Slave GTID Position:       1-1002-20,2-2001-48,0-1002-188</code></pre>
    </div>

    <div class="section" id="Bookmark3__Bookmark12"><h2 class="title sectiontitle">Perform a backup or restore</h2>
      
      <p class="p">These commands must be executed in a pod with curl. It could be the admincli pod if <span class="ph">NCC</span> is
        still deployed or it can be the cbur-master pod if admincli pod is not available.</p>

      <pre class="pre codeblock"><code>kubectl -n sm exec -it brcbur-master-cbur-5d45b98b48-bq27h -- bash</code></pre>
      <pre class="pre codeblock"><code>Set the variables:
CBUR_MASTER_NAMESPACE=sm
NAMESPACE=sm
RELEASENAME=ckey-cmdb 
BR_POLICY_NAME=ckey-cmdb-mariadb</code></pre>
      <p class="p">The curl command to backup is:</p>

      <pre class="pre codeblock"><code>curl -v --header 'Accept: application/json' -X POST http://cbur-master-cbur.$CBUR_MASTER_NAMESPACE.svc.cluster.local:80/v2/helm/release/backup/$NAMESPACE/$RELEASENAME?helm_version=3</code></pre>
      <p class="p">The curl command to restore is:</p>

      <pre class="pre codeblock"><code>curl -vkL --header 'Content-Type: multipart/form-data' --header 'Accept: application/json' -X POST --header 'Content-Type: application/x-www-form-urlencoded' -d 'backup_id=&amp;volume=&amp;object_type=&amp;object_name=' http://cbur-master-cbur.$CBUR_MASTER_NAMESPACE.svc.cluster.local:80/v2/helm/release/restore/$NAMESPACE/$RELEASENAME?helm_version=3</code></pre>
      <p class="p">To restore a specific backup, get a list of backup ids with this command first.</p>

      <pre class="pre codeblock"><code>curl -vkL --header 'Content-Type: multipart/form-data' --header 'Accept: application/json' http://cbur-master-cbur.$CBUR_MASTER_NAMESPACE.svc.cluster.local:80/v1/images/$NAMESPACE/$BR_POLICY_NAME?force=true</code></pre>
      <p class="p">Get list of backup IDs for a brpolicy.</p>

      <pre class="pre codeblock"><code># In the below sample, there are 2 backups taken for CKEY's CMDB with the following IDs: 20220317195102_e03_LOCAL_ig2_ckey-cmdb-mariadb and 20220318000027_e03_LOCAL_ig2_ckey-cmdb-mariadb.
[root@nc1097node02 ~]# kubectl -n ig2 exec -it ig-admincli-7897688f45-znbgz bash
[tpaadmin@ig-admincli-7897688f45-znbgz /]$ CBUR_MASTER_NAMESPACE=ig2
[tpaadmin@ig-admincli-7897688f45-znbgz /]$ NAMESPACE=ig2
[tpaadmin@ig-admincli-7897688f45-znbgz /]$ RELEASENAME=ckey-cmdb
[tpaadmin@ig-admincli-7897688f45-znbgz /]$ BR_POLICY_NAME=ckey-cmdb-mariadb
[tpaadmin@ig-admincli-7897688f45-znbgz /]$ curl -vkL --header 'Content-Type: multipart/form-data' --header 'Accept: application/json'    http://cbur-master-cbur.$CBUR_MASTER_NAMESPACE.svc.cluster.local:80/v1/images/$NAMESPACE/$BR_POLICY_NAME?force=true
* About to connect() to cbur-master-cbur.ig2.svc.cluster.local port 80 (#0)
*   Trying 10.254.210.250...
* Connected to cbur-master-cbur.ig2.svc.cluster.local (10.254.210.250) port 80 (#0)
&gt; GET /v1/images/ig2/ckey-cmdb-mariadb?force=true HTTP/1.1
&gt; User-Agent: curl/7.29.0
&gt; Host: cbur-master-cbur.ig2.svc.cluster.local
&gt; Content-Type: multipart/form-data
&gt; Accept: application/json
&gt;
&lt; HTTP/1.1 200 OK
&lt; date: Fri, 18 Mar 2022 16:12:42 GMT
&lt; content-type: application/json
&lt; content-length: 261
&lt; x-frame-options: SAMEORIGIN
&lt; x-xss-protection: 1; mode=block
&lt; x-content-type-options: nosniff
&lt; x-envoy-upstream-service-time: 1027
&lt; server: envoy
&lt;
{
  "apiVersion": "v1",
  "code": 200,
  "details": {},
  "kind": "Status",
  "message": [
    "20220317195102_e03_LOCAL_ig2_ckey-cmdb-mariadb",
    "20220318000027_e03_LOCAL_ig2_ckey-cmdb-mariadb"
  ],
  "metadata": {},
  "reason": "",
  "status": "Success"
}
* Connection #0 to host cbur-master-cbur.ig2.svc.cluster.local left intact</code></pre>
      <p class="p">Specify the desired backup_id in the command to restore as value to "backup_id"
        parameter.</p>

      <p class="p">This is a sample command to restore a backup with a specific backup ID.</p>

      <pre class="pre codeblock"><code>[root@nc1097node02 ~]# kubectl -n ig2 exec -it ig-admincli-7897688f45-znbgz bash
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl kubectl exec [POD] -- [COMMAND] instead.
Defaulting container name to ig-admincli.
Use 'kubectl describe pod/ig-admincli-7897688f45-znbgz -n ig2' to see all of the containers in this pod.
[tpaadmin@ig-admincli-7897688f45-znbgz /]$ CBUR_MASTER_NAMESPACE=ig2
[tpaadmin@ig-admincli-7897688f45-znbgz /]$ NAMESPACE=ig2
[tpaadmin@ig-admincli-7897688f45-znbgz /]$ RELEASENAME=ckey-cmdb
[tpaadmin@ig-admincli-7897688f45-znbgz /]$ BR_POLICY_NAME=ckey-cmdb-mariadb
[tpaadmin@ig-admincli-7897688f45-znbgz /]$ curl -vkL  --header 'Accept: application/json' -X POST --header 'Content-Type: application/x-www-form-urlencoded' -d 'backup_id=20220317195102_e03_LOCAL_ig2_ckey-cmdb-mariadb&amp;volume=&amp;object_type=&amp;object_name=' http://cbur-master-cbur.$CBUR_MASTER_NAMESPACE.svc.cluster.local:80/v2/helm/release/restore/$NAMESPACE/$RELEASENAME?helm_version=3
* About to connect() to cbur-master-cbur.ig2.svc.cluster.local port 80 (#0)
*   Trying 10.254.210.250...
* Connected to cbur-master-cbur.ig2.svc.cluster.local (10.254.210.250) port 80 (#0)
&gt; POST /v2/helm/release/restore/ig2/ckey-cmdb?helm_version=3 HTTP/1.1
&gt; User-Agent: curl/7.29.0
&gt; Host: cbur-master-cbur.ig2.svc.cluster.local
&gt; Accept: application/json
&gt; Content-Type: application/x-www-form-urlencoded
&gt; Content-Length: 90
&gt;
* upload completely sent off: 90 out of 90 bytes
&lt; HTTP/1.1 202 Accepted
&lt; date: Fri, 18 Mar 2022 19:00:04 GMT
&lt; content-type: application/json
&lt; content-length: 593
&lt; x-envoy-upstream-service-time: 370
&lt; server: envoy
&lt;
{
  "apiVersion": "v1",
  "code": 202,
  "details": {
    "b1991ebd-da98-4cd0-b130-b218475771e6": {
      "backup_id": "20220317195102_e03_LOCAL_ig2_ckey-cmdb-mariadb",
      "brpolicies": "",
      "exclude_brpolicies": "",
      "helm_version": 3,
      "name": "ckey-cmdb",
      "namespace": "ig2",
      "object_name": "",
      "object_type": "all",
      "request": "restoreHelmRelease",
      "volume": "true"
    }
  },
  "kind": "Status",
  "message": "restoreHelmRelease task = b1991ebd-da98-4cd0-b130-b218475771e6 is on!",
  "metadata": {},
  "reason": "",
  "status": "Success"
}</code></pre>
      <p class="p">Both backup and restore are executed asynchronously. To query their status, use this
        command with the correct returned task identifier.</p>

      <pre class="pre codeblock"><code>curl -v --header 'Accept: application/json' -X GET http://cbur-master-cbur.$CBUR_MASTER_NAMESPACE.svc.cluster.local:80/v2/task/&lt;task-identifier&gt;</code></pre>
      <p class="p">Sample output to query status of a manual backup task.</p>

      <pre class="pre codeblock"><code># In this example, the manual backup task with taskid ="ff764500-1b0e-4bf4-8063-f5f4afaef9c5" resulted in a successful backup.
[root@nc1097node02 ~]# kubectl -n ig2 exec -it ig-admincli-7897688f45-znbgz bash
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl kubectl exec [POD] -- [COMMAND] instead.
Defaulting container name to ig-admincli.
Use 'kubectl describe pod/ig-admincli-7897688f45-znbgz -n ig2' to see all of the containers in this pod.
[tpaadmin@ig-admincli-7897688f45-znbgz /]$ CBUR_MASTER_NAMESPACE=ig2
[tpaadmin@ig-admincli-7897688f45-znbgz /]$ NAMESPACE=ig2
[tpaadmin@ig-admincli-7897688f45-znbgz /]$ RELEASENAME=ckey-cmdb
[tpaadmin@ig-admincli-7897688f45-znbgz /]$ BR_POLICY_NAME=ckey-cmdb-mariadb
[tpaadmin@ig-admincli-7897688f45-znbgz /]$ curl -v --header 'Accept: application/json' -X GET http://cbur-master-cbur.$CBUR_MASTER_NAMESPACE.svc.cluster.local:80/v2/task/ff764500-1b0e-4bf4-8063-f5f4afaef9c5
* About to connect() to cbur-master-cbur.ig2.svc.cluster.local port 80 (#0)
*   Trying 10.254.210.250...
* Connected to cbur-master-cbur.ig2.svc.cluster.local (10.254.210.250) port 80 (#0)
&gt; GET /v2/task/ff764500-1b0e-4bf4-8063-f5f4afaef9c5 HTTP/1.1
&gt; User-Agent: curl/7.29.0
&gt; Host: cbur-master-cbur.ig2.svc.cluster.local
&gt; Accept: application/json
&gt;
&lt; HTTP/1.1 200 OK
&lt; date: Fri, 18 Mar 2022 16:19:05 GMT
&lt; content-type: application/json
&lt; content-length: 578
&lt; x-frame-options: SAMEORIGIN
&lt; x-xss-protection: 1; mode=block
&lt; x-content-type-options: nosniff
&lt; x-envoy-upstream-service-time: 11
&lt; server: envoy
&lt;
{
  "apiVersion": "v1",
  "code": 200,
  "details": {},
  "kind": "Status",
  "message": {
    "task_info": {
      "ff764500-1b0e-4bf4-8063-f5f4afaef9c5": {
        "helm_version": 3,
        "name": "ckey-cmdb",
        "namespace": "ig2",
        "request": "backupHelmRelease",
        "timestamp": "20220317195102"
      }
    },
    "task_message": [
      {
        "kind": "BrPolicy",
        "name": "ckey-cmdb-mariadb",
        "reason": "",
        "status": "Success",
        "weight": 0
      }
    ]
  },
  "metadata": {},
  "reason": "",
  "status": "Success"
}
* Connection #0 to host cbur-master-cbur.ig2.svc.cluster.local left intact</code></pre>
    </div>

    
    <div class="section" id="Bookmark3__Bookmark15"><h2 class="title sectiontitle">Rollback a Helm release</h2>
      
      <p class="p">helm rollback &lt;release-name&gt; -n $NAMESPACE --wait --timeout=1200s</p>

    </div>

    <div class="section" id="Bookmark3__Bookmark16"><h2 class="title sectiontitle">Rollback a Helm release to a specific revision</h2>
      
      <pre class="pre codeblock"><code>helm rollback &lt;release-name&gt; &lt;revision-number&gt; -n $NAMESPACE --wait --timeout=1200s</code></pre>
      <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> 
      <ul class="ul">
        <li class="li">These items are impacted when the Servicemanager is inaccessible. <ul class="ul">
            <li class="li">All provisioning traffic.</li>

            <li class="li">Servicemanager related REST API calls.</li>

            <li class="li">Servicemanager GUI access.</li>

            <li class="li">SS7 USSD requests are impacted because of its dependence on Servicemanager's service
              name.</li>

            <li class="li">SS7 communicates with Servicemanagers through its service name since performance
              degradation happens when primary and secondary Servicemanager FQDNs are used. </li>

          </ul>
</li>

        <li class="li">When the User and Role Management GUI is down, authentication requests and all GUIs are
          inaccessible.</li>

        <li class="li">When User and Role Management is down, CGF (DR)'s dr-ui pods try to reach User and Role
          Management and crashloopback after seven failed attempts. If that happens, delete and
          recreate those dr-ui pods.</li>

        <li class="li">When <span class="ph uicontrol">Reimport DR realm</span> = <code class="ph codeph">true</code> and
            <span class="ph uicontrol">Deployment Type</span> = <code class="ph codeph">in-service upgrade</code> in the
            <span class="ph filepath">Inputs.xlsx</span> file, CGF (DR) chart (release name=dr) reupload DR
          realm to User and Role Management when an in-service upgrade is done. To avoid reimports
          in future in-service upgrades, set <span class="ph uicontrol">Reimport DR realm</span> =
            <code class="ph codeph">false</code>.</li>

        <li class="li">When <span class="ph uicontrol">Deployment Type</span> = <code class="ph codeph">in-service upgrade</code> in the
            <span class="ph filepath">Inputs.xlsx</span> file, backup cronjobs are enabled for the MariaDB for
          User and Role Management.</li>

      </ul>

    </div>

    </div>

  </div>
<div class="footer"><hr /><p>Operations, Administration, and Maintenance Guide • P556766-DN1000055092-R23.8 • 1 • <a href="../home.html">Cover</a> • ©2023 Nokia. Nokia Confidential Information • Use subject to agreed restrictions on disclosure and use.</p></div></body>
</html>