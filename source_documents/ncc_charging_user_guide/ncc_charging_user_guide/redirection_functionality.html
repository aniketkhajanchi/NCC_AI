<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta name="copyright" content="(C) Copyright 2023" />
<meta name="DC.rights.owner" content="(C) Copyright 2023" />
<meta name="generator" content="DITA-OT" /><meta name="DC.type" content="concept" />
<meta name="DC.title" content="Redirection functionality" />
<meta name="prodname" content="Nokia Converged Charging" />
<meta name="version" content="Release 23.8" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="id9yz-09126-ug01-pczza-sp1-d1e20069" />
<link rel="stylesheet" type="text/css" href="../../web/css/commonltr.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/styles.min.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/common-extended.css" /><title>Redirection functionality</title>
<script src="../web/js/nswtc.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
<script src="../../web/css/../js/script.min.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
</head>
<body id="id9yz-09126-ug01-pczza-sp1-d1e20069">
<div class="header"><div id="feedback-link-placeholder" class="feedback-link"></div><hr /></div><h1 class="title topictitle1" id="ariaid-title1">Redirection functionality</h1>
<div class="body conbody">
        <p class="p">NCC supports redirection to an URL, or graceful termination of the service. For example,
            during a session, when the credit runs low or is exhausted, NCC can redirect the call
            for recharging, and send a RAR for the session after recharge to ensure the continuity
            of the session. External Equipment (EE) tries to book quota slices. But, as there is
            insufficient credit in the user account to accept the reservation, the charging service
            responds with a result code to warn the EE of non-availability of credit in the
            sub-session. After the account is recharged, the OCS sends RAR for re-authorization of
            credit and call continuity. A redirection timer can be used to add to the slice validity
            time (for the session) when redirection has to happen. This allows redirection to happen
            without closing the session. The corresponding TEMEntities get updated as per the
            validity time in the rule.</p>

        <p class="p">The graceful termination of the ongoing session happens when the subscriber has consumed
            all the final granted units. </p>

        <p class="p">The <em class="ph i">Final-Unit-Action</em> AVP defines the behavior of service element when the user
            account cannot cover the cost of the service and must always be present when the
                <em class="ph i">Final-Unit-Indication</em> AVP is included in a command.</p>

        <p class="p">The <em class="ph i">Restriction-Filter-Rule</em> AVP or the <em class="ph i">Filter-Id</em> AVP is present in the
            Credit-Control-Answer message to check whether the user is also allowed to access other
            services not accessible through the address given in the <em class="ph i">Redirect-Server</em> AVP.</p>

        <p class="p">Following are the <em class="ph i">Final-Unit-Action</em> AVP values:</p>

        <ul class="ul" id="id9yz-09126-ug01-pczza-sp1-d1e20069__ul_bm3_xvb_nwb">
            <li class="li">
                <p class="p">
                    <var class="keyword varname">TERMINATE</var>: The <em class="ph i">Final-Unit-Indication</em> AVP with
                        <em class="ph i">Final-Unit-Action</em> TERMINATE can also include GSU with
                        <em class="ph i">cc-total-octets</em>, and <em class="ph i">Tariff-Time-Change</em>.</p>

            </li>

            <li class="li">
                <p class="p">
                    <var class="keyword varname">REDIRECT</var>: If the <em class="ph i">Final-Unit-Action</em> AVP is set to
                        <var class="keyword varname">REDIRECT</var>, then at least the <em class="ph i">Redirect-Server</em> AVP
                    must be present.</p>

            </li>

            <li class="li">
                <p class="p">
                    <var class="keyword varname">RESTRICT_ACCESS</var> (currently not supported): If the
                        <em class="ph i">Final-Unit-Action</em> AVP is set to <var class="keyword varname">RESTRICT_ACCESS</var>,
                    then either the <em class="ph i">Restriction-Filter-Rule</em> AVP or the <em class="ph i">Filter-Id</em> AVP
                    must be present.</p>

            </li>

        </ul>

        <p class="p">See <a class="xref" href="#id9yz-09126-ug01-pczza-sp1-d1e20069__fuiavpformat">FUI AVP</a> for FUI AVP
            format.</p>

        <div class="note" id="id9yz-09126-ug01-pczza-sp1-d1e20069__note_cm3_xvb_nwb"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> Redirection for main balance threshold is not supported. </div>

        <p class="p">See section <span class="ph uicontrol">5.6 Graceful Service Termination</span> in <span class="ph uicontrol">RFC
                4006</span> for more details.</p>

        <div class="section"><h2 class="title sectiontitle">Assumptions</h2>
            
            <p class="p">Following assumptions apply to redirection feature:</p>

            <ul class="ul">
                <li class="li">
                    <p class="p">Redirection is not applicable to the threshold linked to group or resources
                        linked to group.</p>

                </li>

                <li class="li">
                    <p class="p">Redirection support for Ro voice calls is not supported.</p>

                </li>

                <li class="li">
                    <p class="p">In case of multiple MSCC, if redirection is done for a Rating Group (RG),
                        then same is not applicable for other RG, if applicable.</p>

                </li>

                <li class="li">
                    <p class="p">In cases of redirection where some grant (GSU) is also given in CCA, it is
                        assumed that PGW does the redirection after consumption of the GSU
                        units.</p>

                </li>

            </ul>

        </div>

        <div class="section"><h2 class="title sectiontitle">Redirection and termination behavior</h2>
            
            <p class="p">NCC behaves differently based on the configurations made. Few cases are listed as
                follows: </p>

            <ul class="ul">
                <li class="li"><p class="p">
                        <span class="ph uicontrol">Graceful session termination</span>: Consider that an IMS
                        session is ongoing. Subscriber credit finishes including all
                        buckets/balances used for charging the ongoing session. In this case,
                            <em class="ph i">Final Unit Indication</em> in CCA.FUA = <var class="keyword varname">TERMINATE</var>.
                        That is, FUI AVP is sent with terminate action. The session gets terminated
                        gracefully. See the rule in the following figure.</p>

                    
                    <img class="image" height="288" src="../images/img9yz-09126-ug01-pczza-sp1-redirect_ex_default.png" width="576" />
                </li>

                <li class="li"><strong class="ph b">Redirection to a new destination number</strong>: For the case where OCS instructs
                    MTAS/NGIN AS to connect to a new destination number based on the reported
                    digits, the Service-Parameter-Info AVP can be used to pass the new destination
                    number. OCS can perform the logic according to specific configuration, that is,
                    in this case, results in connection to a new destination number. OCS instructs
                    the MTAS/NGIN to proceed with the current call without OCS control
                    (Result-Code=DIAMETER_CREDIT_CONTROL_NOT APPLICABLE) and pass the new
                    destination number inside the Service-Parameter-Info AVPs (SP Type = 307, SP
                    Value = new destination number in E164 format), together with announcement
                    information, if applicable.<p class="p"><strong class="ph b">Example</strong>: IMS ABD call is made,
                        Service-Parameter-Info AVP is used to carry the redirect information along
                        with announcement information in response. </p>
<p class="p"><strong class="ph b">Pre-condition:</strong>
                        Ensure that the following configurations are made:</p>
<ul class="ul" id="id9yz-09126-ug01-pczza-sp1-d1e20069__ul_gyc_4gf_5nb">
                        <li class="li">Following Diameter VSA dictionaries are defined:<ul class="ul" id="id9yz-09126-ug01-pczza-sp1-d1e20069__ul_fvz_4hf_5nb">
                                <li class="li">/opt/tpa/conf/sac/diameter/vsa/CustomVendorDefinition.xml</li>

                                <li class="li">/opt/tpa/conf/sac/diameter/vsa/AttributeDefinition.xml</li>

                                <li class="li">/opt/tpa/conf/sac/diameter/rule/ChargingVsaToContextMapping.xml</li>

                            </ul>
</li>

                        <li class="li">Complex map and Charging RSV is configured to set Service-Parameter-Info
                            in response.</li>

                        <li class="li">Charging RSV is configured to set Announcement information in
                            response.</li>

                        <li class="li">Diameter result code 4011 is configured in response to redirect
                            scenario.</li>

                    </ul>
<p class="p"><strong class="ph b">Complex Map table configuration</strong>:</p>
<img class="image break" id="id9yz-09126-ug01-pczza-sp1-d1e20069__image_izd_btx_tnb" src="../images/redirection_complex_map1.png" height="225" width="515" /><img class="image break" id="id9yz-09126-ug01-pczza-sp1-d1e20069__image_f5l_ftx_tnb" src="../images/redirection_complex_map2.png" height="193" width="577" /><p class="p">Charging RSV rule configuration for trigger
                            <strong class="ph b">IMS_CALL_ESTABLISHMENT</strong>:</p>
<img class="image break" id="id9yz-09126-ug01-pczza-sp1-d1e20069__image_rwm_n2y_tnb" src="../images/redierction_rule1.png" height="660" width="564" /><img class="image break" id="id9yz-09126-ug01-pczza-sp1-d1e20069__image_gy4_42y_tnb" src="../images/redirection_rule2.png" height="704" width="570" /><p class="p"><strong class="ph b">Expected result:</strong> The correct
                        Result-Code, Service-Parameter-Info, and announcement information is set to
                        CCA.</p>
</li>

                <li class="li"><p class="p"><span class="ph uicontrol">Redirection to a URL</span>: Consider that a Gy session is
                        ongoing. Subscriber credit finishes including all buckets or balances used
                        for charging the ongoing session. In this case, consider that a redirection
                        URL is configured. Subscriber is redirected to the configured URL.
                        Subscriber recharges. RAR is sent to gateway in case of Gy session. To
                        continue the session, the new MSCC in update and terminate feature is
                        used.</p>

                    
                    <img class="image" height="288" src="../images/img9yz-09126-ug01-pczza-sp1-redirect_ex0_default.png" width="576" />
                </li>

            </ul>

            <p class="p">Note the following additional points:</p>

            <ul class="ul">
                <li class="li">
                    <p class="p">Operators can configure the redirect URL per <em class="ph i">Rating Result Code</em> from
                        rating. This ensures that the redirection is made to the right server based
                        on the condition of the call. There can be different servers to redirect to
                        based on the status of call (result_code). For example, if the account is in
                        barred state, redirect to customer care. If a subscription is exhausted,
                        redirect to self-care. Operators can create any condition that is supported
                        in the <em class="ph i">RATING_POST_PROCESSING</em> trigger. In most of the cases, MSCC and
                        rating result code is used.</p>

                </li>

                <li class="li">
                    <p class="p">NCC behaves differently based on the value indicated in the
                            <em class="ph i">Final-Unit-Action</em> AVP. Based on the value, NCC may perform the
                        actions <samp class="ph systemoutput">TERMINATE</samp> or
                            <samp class="ph systemoutput">REDIRECT</samp>.</p>

                </li>

                <li class="li">
                    <p class="p">Operators can also configure NCC not to send <em class="ph i">Final-Unit-Action</em> set to
                            <samp class="ph systemoutput">REDIRECT</samp>, but
                            <samp class="ph systemoutput">TERMINATE</samp>, which can be done using
                        rules.</p>

                </li>

                <li class="li">
                    <p class="p">If the <em class="ph i">Final-Unit-Indication</em> action is set to
                            <samp class="ph systemoutput">TERMINATE</samp> and if the subsequent call is of
                        type <samp class="ph systemoutput">Update</samp>, then RSU is ignored and the
                        session is terminated.</p>

                </li>

                <li class="li">
                    <p class="p">If the MSCC result code is 4012 and FUI rules with redirect action is
                        configured in the <em class="ph i">RATING_POST_PROCESSING</em> trigger, then the validity
                        time of Gy session is set to 24 hours. The session audit clears the session
                        after this time. The <em class="ph i">Validity Time</em> configured in the rule does not
                        impact the default behavior.</p>

                </li>

            </ul>

        </div>

        <div class="section" id="id9yz-09126-ug01-pczza-sp1-d1e20069__fuiavpformat"><h2 class="title sectiontitle">FUI AVP</h2>
            
            <p class="p">The FUI AVP format is as follows.</p>

            <div class="fig fignone">
                <pre class="pre codeblock"><code>Final-Unit-Indication ::= &lt; AVP Header: 430 &gt;
                                { Final-Unit-Action }
                               *[ Restriction-Filter-Rule ]
                               *[ Filter-Id ]
                                [ Redirect-Server ]</code></pre>
            </div>

        </div>

        <div class="section">
            <p class="p"><strong class="ph b">Terminate action</strong></p>

            <p class="p">The <em class="ph i">Final-Unit-Indication</em> AVP with <em class="ph i">Final-Unit-Action</em> TERMINATE can also
                include GSU with cc-total-octets, and <em class="ph i">Tariff-Time-Change</em>.
                
                When the subscriber has consumed the final granted units, the service element
                terminates the service. This is the default handling applicable whenever an
                unsupported <em class="ph i">Final-Unit-Action</em> value is received. A final
                Credit-Control-Request message to NCC is sent when the <em class="ph i">Final-Unit-Indication</em>
                AVP indicating action <samp class="ph systemoutput">TERMINATE</samp> was present. The
                    <em class="ph i">CC-Request-Type</em> AVP in the request is set to the value
                    <var class="keyword varname">TERMINATION_REQUEST</var>.</p>

        </div>

        <div class="section">
            <p class="p"><strong class="ph b">Redirect action</strong></p>

            <p class="p">The <em class="ph i">Final-Unit-Indication</em> AVP with <em class="ph i">Final-Unit-Action</em>
                <samp class="ph systemoutput">REDIRECT</samp> indicates that upon consumption of the final
                granted units, the subscriber must be redirected to the address specified in the
                    <em class="ph i">Redirect-Server</em> AVP.</p>

        </div>

        <div class="section">
            <p class="p"><strong class="ph b">Additional information</strong></p>

            <p class="p">When NCC is configured to trigger FUI with any FUA value, it grants final zero
                quota.</p>

            <p class="p">When NCC had previously triggered FUI with any FUA value, it can accept the final
                zero used quota.</p>

            <p class="p">NCC accepts any incoming RSU and USU after the <em class="ph i">Final-Unit-Indication</em>, and
                grants the quota accordingly or triggers a new <em class="ph i">Final-Unit-Indication</em> with
                GSU.</p>

            <p class="p">NCC allows the gateway to request new quota even after the target service (MSCC/MUU)
                has been finalized with CCR that had <em class="ph i">Reporting-Reason</em> AVP as
                <em class="ph i">Final</em>.</p>

        </div>

        <div class="section"><h2 class="title sectiontitle">Result codes</h2>
            
            <p class="p">See <a class="xref" href="cresultcode.html">Appendix: Result and error codes</a> for charging result codes.</p>

        </div>

        <div class="section"><h2 class="title sectiontitle">Examples</h2>
            
            <p class="p">All the scenarios listed in this section work for IMS as well. Configure FUI rules in
                    <em class="ph i">GY_CREDIT_REQUEST</em> only in case device is in barred state and request type
                is <var class="keyword varname">INITIAL</var>.</p>

            <div class="sectiondiv">
                <p class="p"><strong class="ph b">Example 1: Not enough credit (partial reservation case)</strong></p>

                <p class="p">NCC receives a GY CCR(U) but does not have sufficient balance to reserve all the
                    RSU. Only partial reservation is possible. It sends CCA with 2001 result code
                    and FUI AVP with 2002 at MSCC level. </p>

                <p class="p">Configure a rule with <em class="ph i">RATING_POST_PROCESSING</em> trigger as follows:</p>

                <div class="fig fignone">
                    
                    <img class="image break" src="../images/img9yz-09126-ug01-pczza-sp1-redirect_ex1_default.png" />
                </div>

                <p class="p">For CCA with FUI AVP within MSCC AVP for update message is received.</p>

                <div class="fig fignone">
                    <pre class="pre codeblock"><code>AVP Validity-Time: 448 , M: true              , V: 0      , value: 390 (unsigned32)
  Group Final-Unit-Indication: 430             , M: true              , V: 0
    AVP Final-Unit-Action: 449       , M: true              , V: 0      , value: 1 (enumerated)
    Group Redirect-Server: 434     , M: true              , V: 0
        AVP Redirect-Address-Type: 433       , M: true              , V: 0      , value: 2 (enumerated)
        AVP Redirect-Server-Address: 435    , M: true              , V: 0      , value: www.redirectURLRSV.com (UTF8String)
</code></pre>
                </div>

                <p class="p">In this example, the validity time is 390. Out of which, 360 is from quota
                    management profile (slicing profile) and 30 is configured in the rule.</p>

                <p class="p">When the call is redirected to the specified URL and the device renews the
                    subscription, NCC sends a RAR message followed by RAA from the PGW. Thereafter,
                    PGW comes back with CCR(U) for the same session and the call continues.</p>

            </div>
            <div class="sectiondiv">
                <p class="p"><strong class="ph b">Example 2: No balance available (4012 case)</strong></p>

                <p class="p">NCC receives a GY CCR(U) but does not have balance even for partial reservation.
                    It sends CCA with 2001 result code and FUI AVP with 4012 at MSCC level.</p>

                <p class="p">Configure a rule with <em class="ph i">RATING_POST_PROCESSING</em> trigger as follows:</p>

                <div class="fig fignone">
                    
                    <img class="image break" src="../images/img9yz-09126-ug01-pczza-sp1-redirect_ex2_default.png" />
                </div>

                <p class="p">CCA with FUI AVP for update message is received.</p>

                <div class="fig fignone">
                    <pre class="pre codeblock"><code>Group Final-Unit-Indication: 430 , M: true ,
V: 0
AVP Final-Unit-Action: 449 , M: true , V: 0 ,
value: 1 (enumerated)
Group Redirect-Server: 434 , M: true , V: 0
AVP Redirect-Address-Type: 433 , M: true , V:
0 , value: 2 (enumerated)
AVP Redirect-Server-Address: 435 , M: true , V:
0 , value: www.notEnoughBalanceRedirect.com (UTF8String)
</code></pre>
                </div>

                <p class="p">In this case, GSU is not granted. As specified in the assumptions, the validity
                    time of Gy session is set to 24 hours.</p>

            </div>
            <div class="sectiondiv"><p class="p"><strong class="ph b">Example 3: Account is in barred state</strong></p>
<p class="p">Charging is done from
                    the account (main balance) and it is in barred state.</p>
<p class="p">Condition is on
                    rating result code <samp class="ph systemoutput">20007
                        NOT_ENOUGH_CREDIT_ACCOUNT_BARRED</samp>
                </p>
<p class="p">Configure the following charging rule for <em class="ph i">RATING_POST_PROCESSING</em>
                    trigger.</p>

                <kbd class="ph userinput">if CALL_COMMON.Rating.Result-Code = 20007 then
                    RATING.Final-Unit-Action-Redirect ( "http://www.nokia.com" , 60,
                    RedirectAddressType_URL ) </kbd>
                <p class="p">CCA with FUI AVP successful initial message received.</p>
<div class="fig fignone">
                    <pre class="pre codeblock"><code>Group Final-Unit-Indication: 430             , M: true              , V: 0
    AVP Final-Unit-Action: 449       , M: true              , V: 0      , value: 1 (enumerated)
    Group Redirect-Server: 434     , M: true              , V: 0
        AVP Redirect-Address-Type: 433       , M: true              , V: 0      , value: 2 (enumerated)
        AVP Redirect-Server-Address: 435    , M: true              , V: 0      , value: http://www.nokia.com (UTF8String)
</code></pre>
                </div>
</div>
            <div class="sectiondiv"><strong class="ph b">Example 4: Account barred during update</strong><p class="p">NCC receives GY CCRI and
                    sends CCA. </p>
<p class="p">The account state is changed to barred.</p>
<p class="p">NCC receives GY
                    CCRU (an update request) and sends CCA with 4010 mscc result code, FUI AVP at
                    MSCC level.</p>
<p class="p">Charging is done from the main account
                    balance.</p>
<p class="p">Configure a charging rule with RATING_POST_PROCESSING trigger.
                    </p>
<p class="p">Condition is on rating result code that is <samp class="ph systemoutput">41019
                        NEW_RES_NOT_ALLOWED_ACCOUNT_BARRED</samp>.</p>

                <kbd class="ph userinput">if CALL_COMMON.Rating.Result-Code = 41019 then
                    RATING.Final-Unit-Action-Redirect ( "http://www.nokia.com" , 60,
                    RedirectAddressType_URL)</kbd>
                <p class="p">CCA with FUI AVP for update message is received.</p>
<div class="fig fignone">
                    <pre class="pre codeblock"><code>Group Final-Unit-Indication: 430             , M: true              , V: 0
    AVP Final-Unit-Action: 449       , M: true              , V: 0      , value: 1 (enumerated)
    Group Redirect-Server: 434     , M: true              , V: 0
        AVP Redirect-Address-Type: 433       , M: true              , V: 0      , value: 2 (enumerated)
        AVP Redirect-Server-Address: 435    , M: true              , V: 0      , value: http://www.nokia.com (UTF8String)</code></pre>
                </div>

            </div>
        </div>

    </div>
<div class="footer"><hr /><p>Charging User Guide • P556766-DN1000054947-R23.8 • 1 • <a href="../home.html">Cover</a> • ©2023 Nokia. Nokia Confidential Information • Use subject to agreed restrictions on disclosure and use.</p></div></body>
</html>