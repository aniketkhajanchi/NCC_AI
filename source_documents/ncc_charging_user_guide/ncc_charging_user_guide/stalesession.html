<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta name="copyright" content="(C) Copyright 2023" />
<meta name="DC.rights.owner" content="(C) Copyright 2023" />
<meta name="generator" content="DITA-OT" /><meta name="DC.type" content="concept" />
<meta name="DC.title" content="Stale session audit" />
<meta name="prodname" content="Nokia Converged Charging" />
<meta name="version" content="Release 23.8" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="id9yz-09126-ug01-pczza-sp1-stalesession" />
<link rel="stylesheet" type="text/css" href="../../web/css/commonltr.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/styles.min.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/common-extended.css" /><title>Stale session audit</title>
<script src="../web/js/nswtc.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
<script src="../../web/css/../js/script.min.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
</head>
<body id="id9yz-09126-ug01-pczza-sp1-stalesession">
<div class="header"><div id="feedback-link-placeholder" class="feedback-link"></div><hr /></div><h1 class="title topictitle1" id="ariaid-title1">Stale session audit</h1>
<div class="body conbody">
<div class="section">
<p class="p">NCC maintains three kinds of sessions as follows:</p>
<ul class="ul">
<li class="li">
<p class="p">
<span class="ph uicontrol">Diameter Gy session</span>: It is maintained by the Call Controller and identified by the Diameter Session-Id.</p>

</li>

<li class="li">
<p class="p">
<strong class="ph b">VoLTE IMS Ro session</strong>: It is maintained by the Call Controller.</p>

</li>

<li class="li">
<p class="p">
<span class="ph uicontrol">Charging session</span>: It is maintained by the Rating Engine, and identified by the Diameter Session-Id and MSCC Rating-Group or Service-Identifier.</p>

</li>

</ul>

<p class="p">A Diameter Gy session is considered as a stale session if all of the associated charging sessions have expired. When a Diameter Gy session expires, audit initiates a re-authorization service for the expired Gy session by issuing a Re-Auth-Request (RAR) message to the network.</p>

<p class="p">Audit for VoLTE IMS Ro session clears the stale IMS session along with the corresponding rating session on the expiry of validity time  of MSCC in IMS session. The audit mechanism triggers a RAR message to check the expiry of the IMS session. The session is cleared if the RAA message is unsuccessful and session maintained if the RAA message is received successfully.</p>

<p class="p">The expiry of a charging session is determined by the value of <em class="ph i">Validity-Time (VT)</em> AVP
                present in the <em class="ph i">Multiple-Services-Credit-Control (MSCC)</em> AVP. However, the VT
                can be modified through rules in the <span class="ph uicontrol">Quota Management Profile (slicing
                    profile)</span> entity using the SM GUI. When a charging session expires,
                audit initiates a re-authorization service for the expired charging session by
                issuing RAR message to the network. Unlike the RAR sent for re-authorizing a Gy
                session which consists of Session-Id only, the RAR sent for charging session has
                either <em class="ph i">Rating-Group</em> AVP or <em class="ph i">Service-Identifier</em> AVP.</p>

<p class="p">A successful re-authorization (Diameter result code = 2xxx) indicates that the session is active and should not be cleared. Otherwise, the session is cleared.</p>

<div class="p">The following figure shows the VT variable in the SM GUI:<div class="fig fignone">
                    
                    <img class="image break" src="../images/img9yz-09126-ug01-pczza-sp1-vt_default.png" height="222" width="357" />
                </div>
</div>

</div>

        <div class="section" id="id9yz-09126-ug01-pczza-sp1-stalesession__section_bln_mmx_1pb"><h2 class="title sectiontitle">Audit behavior</h2>
            
            <div class="p">
                <table cellpadding="4" cellspacing="0" summary="" id="id9yz-09126-ug01-pczza-sp1-stalesession__table_csp_nmx_1pb" class="table" frame="border" border="1" rules="all"><caption><span class="tablecap"><span class="table--title-label">Table: </span>Audit behavior for single-MSCC calls </span></caption><colgroup><col /><col /><col /></colgroup><thead class="thead" style="text-align:left;">
                            <tr class="row">
                                <th class="entry cellrowborder" style="vertical-align:top;" id="d377646e119">Audit type</th>

                                <th class="entry cellrowborder" style="vertical-align:top;" id="d377646e122">Result code</th>

                                <th class="entry cellrowborder" style="vertical-align:top;" id="d377646e125">Behavior</th>

                            </tr>

                        </thead>
<tbody class="tbody">
                            <tr class="row">
                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e119 ">Session</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e122 ">2001</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e125 ">Extends for Gy Inactivity Timer (24 hrs)</td>

                            </tr>

                            <tr class="row">
                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e119 ">Session</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e122 ">Any other than 2001</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e125 ">Clear session</td>

                            </tr>

                            <tr class="row">
                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e119 ">Session With Unknown Result</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e122 ">Any other than 5002</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e125 ">Extends for Gy Inactivity Timer (24 hrs)</td>

                            </tr>

                            <tr class="row">
                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e119 ">Session With Unknown Result</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e122 ">5002</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e125 ">Clear session</td>

                            </tr>

                            <tr class="row">
                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e119 ">MSCC</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e122 ">2001</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e125 ">Extends for Gy Inactivity Timer (24 hrs)</td>

                            </tr>

                            <tr class="row">
                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e119 ">MSCC</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e122 ">Any other than 2001</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e125 ">Clear session</td>

                            </tr>

                            <tr class="row">
                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e119 ">MSCC With Unknown Result</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e122 ">Any other than 5002</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e125 ">Extends for Gy Inactivity Timer (24 hrs)</td>

                            </tr>

                            <tr class="row">
                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e119 ">MSCC With Unknown Result</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e122 ">5002</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e125 ">Clear session</td>

                            </tr>

                        </tbody>
</table>

                <table cellpadding="4" cellspacing="0" summary="" id="id9yz-09126-ug01-pczza-sp1-stalesession__table_dsp_nmx_1pb" class="table" frame="border" border="1" rules="all"><caption><span class="tablecap"><span class="table--title-label">Table: </span>Audit behavior for multiple MSCC calls (assume VT1 = 30 s, VT2 = 60
                        s)</span></caption><colgroup><col /><col /><col /></colgroup><thead class="thead" style="text-align:left;">
                            <tr class="row">
                                <th class="entry cellrowborder" style="vertical-align:top;" id="d377646e249">Audit Type</th>

                                <th class="entry cellrowborder" style="vertical-align:top;" id="d377646e252">Result Code for VT1 Expiry</th>

                                <th class="entry cellrowborder" style="vertical-align:top;" id="d377646e255">Behavior</th>

                            </tr>

                        </thead>
<tbody class="tbody">
                            <tr class="row">
                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e249 ">Session</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e252 ">2001</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e255 ">Extends for VT2-VT1 (30 secs)</td>

                            </tr>

                            <tr class="row">
                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e249 ">Session</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e252 ">Any other than 2001</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e255 ">Clear session</td>

                            </tr>

                            <tr class="row">
                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e249 ">Session With Unknown Result</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e252 ">Any other than 5002</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e255 ">Extends for VT2-VT1 (30 secs)</td>

                            </tr>

                            <tr class="row">
                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e249 ">Session With Unknown Result</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e252 ">5002</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e255 ">Clear session</td>

                            </tr>

                            <tr class="row">
                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e249 ">MSCC</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e252 ">2001</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e255 ">Extends for VT2-VT1 (30 secs)</td>

                            </tr>

                            <tr class="row">
                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e249 ">MSCC</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e252 ">Any other than 2001</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e255 ">Clear session</td>

                            </tr>

                            <tr class="row">
                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e249 ">MSCC With Unknown Result</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e252 ">Any other than 5002</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e255 ">Extends for VT2-VT1 (30 secs)</td>

                            </tr>

                            <tr class="row">
                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e249 ">MSCC With Unknown Result</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e252 ">5002</td>

                                <td class="entry cellrowborder" style="vertical-align:top;" headers="d377646e255 ">Clear session</td>

                            </tr>

                        </tbody>
</table>

            </div>

            <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> The application preference <var class="keyword varname">Stale N40 Gy Session Audit Algo</var>
                handles how audit RAR is transmitted. By default the audit RAR is transmitted per
                MSCC. It is applicable for Gy/N40/IMS interface.<div class="p">
                    <ol class="ol" id="id9yz-09126-ug01-pczza-sp1-stalesession__ol_nkv_p5x_1pb">
                        <li class="li">For 5G Result codes are mapped as 2001 → 201 and 5002 → 404 (with error
                            cause <var class="keyword varname">SUBSCRIPTION_NOT_FOUND</var>).</li>

                        <li class="li">To remove the sessions for <strong class="ph b">Session With Unknown Result</strong> and
                                <strong class="ph b">MSCC With Unknown Result</strong> in case of 5G, result code mapping
                            has to be added for 404 with error cause code
                                <var class="keyword varname">SUBSCRIPTION_NOT_FOUND</var> to 5002 in
                                <span class="ph filepath">ChargingServiceConversion.xml</span> as follows:</li>

                        <li class="li">Reload required after changes in
                                <var class="keyword varname">ChargingServiceConversion.xml</var>.<pre class="pre codeblock"><code>&lt;!-- ============= Charging side mapping starts here ================= --&gt;
&lt;diameterInitiatedExchange
httpType="Nchf_ConvergedCharging_Notify"
diameterApplication="N40"
diameterCommand="Re-Auth-Request"&gt;
&lt;request&gt;
&lt;converter ref="ChargingNotifyRequest"/&gt;
&lt;/request&gt;
&lt;response&gt;
&lt;diameterResultCodeMap defSuccessResultCode="DIAMETER_SUCCESS"
defFailureResultCode="DIAMETER_UNABLE_TO_COMPLY"&gt;
 &lt;valueMap httpStatusCode="404" httpErrorCause="SUBSCRIPTION_NOT_FOUND" diameterResultCode="DIAMETER_UNKNOWN_SESSION_ID"/&gt; → <strong class="ph b">Only this line to be added</strong>
&lt;/diameterResultCodeMap&gt;
&lt;/response&gt;
&lt;/diameterInitiatedEx</code></pre></li>

                    </ol>

                </div>
</div>

            <p class="p">Session audit was done through <em class="ph i">TEMEntity</em> (a separate set in database), and
                    <em class="ph i">TEMScanner</em>.</p>

            <div class="p">Currently, session audit can be executed through <em class="ph i">DDTEMEntity</em> (a part of the
                    <em class="ph i">tem</em> bin in <em class="ph i">DynamicData</em>), and <em class="ph i">DDTEMScanner</em>. If the
                application preference <em class="ph i">Use DynamicData TEM for sessions</em> is set to
                    <var class="keyword varname">1</var>, then the new <em class="ph i">DDTEMEntity</em>, and DDTEMScanner are used
                for session audits. It is applicable only for CNF environment.<div class="note" id="id9yz-09126-ug01-pczza-sp1-stalesession__note_mdt_cnz_4tb"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> For more details on the application preference <em class="ph i">Use
                        DynamicData TEM for sessions</em>, refer to section <em class="ph i">Managed Element
                        application preferences</em> in the <em class="ph i">Global Configuration
                Guide</em>.</div>
</div>

        </div>

</div>
<div class="footer"><hr /><p>Charging User Guide • P556766-DN1000054947-R23.8 • 1 • <a href="../home.html">Cover</a> • ©2023 Nokia. Nokia Confidential Information • Use subject to agreed restrictions on disclosure and use.</p></div></body>
</html>