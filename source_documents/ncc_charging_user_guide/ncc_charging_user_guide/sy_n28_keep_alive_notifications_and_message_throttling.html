<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta name="copyright" content="(C) Copyright 2023" />
<meta name="DC.rights.owner" content="(C) Copyright 2023" />
<meta name="generator" content="DITA-OT" /><meta name="DC.type" content="concept" />
<meta name="DC.title" content="Sy and N28 keep-alive notifications and message throttling" />
<meta name="prodname" content="Nokia Converged Charging" />
<meta name="version" content="Release 23.8" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="sy_n28_keep_alive_notifications_and_message_throttling" />
<link rel="stylesheet" type="text/css" href="../../web/css/commonltr.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/styles.min.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/common-extended.css" /><title>Sy and N28 keep-alive notifications and message throttling</title>
<script src="../web/js/nswtc.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
<script src="../../web/css/../js/script.min.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
</head>
<body id="sy_n28_keep_alive_notifications_and_message_throttling">
<div class="header"><div id="feedback-link-placeholder" class="feedback-link"></div><hr /></div><h1 class="title topictitle1" id="ariaid-title1">Sy and N28 keep-alive notifications and message throttling</h1>
<div class="body conbody">
        <div class="section" id="sy_n28_keep_alive_notifications_and_message_throttling__section_q3g_tzz_w4b">
            <div class="p">NCC provides the following capabilities for managing Sy and
                    <var class="keyword varname">Nchf_SpendingLimitControl</var> (N28) sessions:<ul class="ul" id="sy_n28_keep_alive_notifications_and_message_throttling__ul_stg_f1d_ypb">
                    <li class="li">
                        <p class="p">The ability to trigger <em class="ph i">keep-alive</em> notifications if no intermediate
                            SLRs and <var class="keyword varname">Nchf_SpendingLimitControl</var> report retrieval
                            are sent within a configurable idle session interval.</p>

                    </li>

                    <li class="li">
                        <div class="p">The ability to throttle the overall rate of SNR and
                                <var class="keyword varname">Nchf_SpendingLimitControl_Notify</var> messages sent
                            from the system (including both <em class="ph i">keep-alive</em> and <em class="ph i">real</em>
                            notifications) can be defined using the following two parameters:<ul class="ul" id="sy_n28_keep_alive_notifications_and_message_throttling__ul_atc_xwz_w4b">
                                <li class="li">Maximum number of notifications (both <em class="ph i">keep-alive</em> and
                                        <em class="ph i">real</em>) that can be sent.</li>

                                <li class="li">Interval over which they can be sent.</li>

                            </ul>
</div>

                    </li>

                </ul>
</div>

            <p class="p">Separate throttling parameters can be defined for 4G Sy and 5G
                    <var class="keyword varname">Nchf_SpendingLimitControl</var> sessions. The message rates and
                throttling are managed separately for Sy SNRs and
                    <var class="keyword varname">Nchf_SpendingLimitControl_Notify</var>.</p>

            <p class="p">All notifications for a given Sy and <var class="keyword varname">Nchf_SpendingLimitControl</var>
                session must be sent in the order they are generated.</p>

            <p class="p">A retry mechanism is available so that notifications can be resent if no
                acknowledgement is received from the PCRF/PCF within a configurable timeout interval
                (or if other send failures are encountered). Separate 4G and 5G parameters can be
                configured for retry wait interval. Maximum retries can be configured for
                    <em class="ph i">real</em> and <em class="ph i">keep-alive</em> notifications.</p>

            <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> 
                <ul class="ul" id="sy_n28_keep_alive_notifications_and_message_throttling__ul_o13_nvx_1qb">
                    <li class="li">If keep alive audit is triggered in between real SNR retry then it is
                        dropped and keep alive retry count is not reset.</li>

                    <li class="li">For the configuration parameters, refer to section <em class="ph i">Outbound
                            configuration</em> in the <em class="ph i">Diameter/HTTP Configuration Guide</em>.</li>

                </ul>

            </div>

        </div>

        <div class="section" id="sy_n28_keep_alive_notifications_and_message_throttling__section_xss_r32_ypb"><h2 class="title sectiontitle"><em class="ph i">keep-alive</em> SNR</h2>
            
            <ol class="ol" id="sy_n28_keep_alive_notifications_and_message_throttling__ol_ehz_j3h_x4b1">
                <li class="li">If SLR/SLA or SNR/SNA has not been exchanged in a Sy session for the duration as
                    specified in the application preference <em class="ph i">OCS Sy Session Inactivity Duration
                        (seconds)</em>, then a <em class="ph i">keep-alive</em> SNR is sent to the PCRF in order to
                    check whether the Sy session is alive or not.</li>

                <li class="li">If there is a timeout in the receiving SNA, a retry is made after the time that
                    is configured in the parameter <strong class="ph b">Keep Alive Consecutive Retry Interval
                    (ms)</strong>. This retry is made for the number of retry counts configured into the
                    parameter <strong class="ph b">Max Keep Alive Consecutive Retry Count</strong>.</li>

                <li class="li">When the last retry fails, the next retry is attempted after the time specified
                    in the parameter <strong class="ph b">Keep Alive Retry Interval (min)</strong>. This retry follows the
                    previous step. The retry mechanism in this step is repeated for a number of
                    retry count configured in <strong class="ph b">Max Keep Alive Retry Count</strong> parameter.</li>

                <li class="li">If there is a timeout on a retry, SNA is returned with the diameter result code
                    configured in <strong class="ph b">Result Codes to Remove Session</strong>, for example, 5002 (unknown
                    session ID). Then the Sy session is cleared. Else, the Sy session timestamp is
                    updated with the latest timestamp.</li>

                <li class="li">If <strong class="ph b">Max Keep Alive Retry Count</strong> is set to -1, or the application preference
                        <em class="ph i">Enable SNR Throttling and Keep Alive</em> is disabled, then the session
                    audit removes the session without any retry.</li>

                <li class="li">If <strong class="ph b">Empty Keep Alive SNR</strong> check box is selected in the outbound
                    configuration, then <em class="ph i">Keep Alive SNR</em> is sent without any Policy Counter ID
                    and status.</li>

            </ol>

        </div>

        <div class="section" id="sy_n28_keep_alive_notifications_and_message_throttling__section_ujd_q32_ypb"><h2 class="title sectiontitle">SNA handling</h2>
            
            <ol class="ol" id="sy_n28_keep_alive_notifications_and_message_throttling__ol_epd_yqh_x4b">
                <li class="li">For each SNR sent to Policy, NCC waits and checks for an SNA response.</li>

                <li class="li">If SNA is received with result code configured in <strong class="ph b">Result Codes to Remove
                        Session</strong>, then the session is removed from NCC.</li>

                <li class="li">For real SNR, if network returns any of the result codes defined in <strong class="ph b">Result
                        Code to Skip Retry</strong> (for example, too busy), then retry does take place.
                    It waits for the occurrence of the next network event (like CCR/SLR/SNA) to send
                    the SNR.</li>

                <li class="li">For <em class="ph i">keep-alive</em> SNR, next retry takes place after the time defined in
                        <strong class="ph b">Keep Alive Retry Interval (min)</strong>.</li>

                <li class="li">If the network returns any of the result codes not present in <strong class="ph b">Result Codes to
                        Skip Retry</strong> or <strong class="ph b">Result Codes to Remove Session</strong>, then NCC retries
                    the SNR with configurable time as per the separate timeout intervals, and number
                    of retries defined for <em class="ph i">keep-alive</em> and real SNRs.</li>

                <li class="li">If a response is not received in the configured <strong class="ph b">Response Time for SNA</strong>, or
                    if other send failures are encountered, then NCC retries the SNR <em class="ph i">n</em> times
                    with a configurable interval for SNR retry.</li>

                <li class="li">The retry is based on a timer value and is as configured in the outbound
                    configuration entity.</li>

                <li class="li">For session terminate request, if SNA is received with result code other than
                        <var class="keyword varname">2XXX</var>, then the result code is modified to
                        <var class="keyword varname">2001</var>. This forces the session terminate request to return
                    a success response.</li>

                <li class="li">This is applicable for <em class="ph i">Sy</em> and
                        <var class="keyword varname">Nchf_SpendingLimitControl_Notifications</var>.</li>

                <li class="li">This is applicable for both <em class="ph i">keep-alive</em> and <em class="ph i">real</em> SNR.</li>

            </ol>

        </div>

        <div class="section" id="sy_n28_keep_alive_notifications_and_message_throttling__section_twm_432_ypb"><h2 class="title sectiontitle">Re-transmission bit for retry</h2>
            
            <ul class="ul" id="sy_n28_keep_alive_notifications_and_message_throttling__ul_xxw_hk3_xpb">
                <li class="li">When retrying any notification, set the re-transmission bit, to indicate
                    retry.</li>

                <li class="li">This is applicable for consecutive retries of SNR messages.</li>

                <li class="li">T-bit is not set for N28 messages as there is no T-bit equivalent in N40 or N28
                    notifications for 5G standards.</li>

            </ul>

        </div>

        <div class="section" id="sy_n28_keep_alive_notifications_and_message_throttling__section_ls5_m32_ypb"><h2 class="title sectiontitle">Multiple notifications for the same session</h2>
            
            <ol class="ol" id="sy_n28_keep_alive_notifications_and_message_throttling__ol_wcq_f1j_x4b">
                <li class="li">The multiple notifications for the same session (<em class="ph i">keep-alive</em>/real
                    SNR/retry) is consolidated or sent externally in the same order in which they
                    are generated.</li>

                <li class="li">If the two SNRs are generated simultaneously for the same session, then only one
                    SNR is sent with latest policy counter status. If the new notification is
                    generated while waiting for an SNA, then the new SNR is also sent upon receiving
                    the SNA.</li>

                <li class="li">If a real notification is generated when <em class="ph i">keep-alive</em> is already in queue,
                    the <em class="ph i">keep-alive</em> notification is dropped, and is not sent to PCF.</li>

                <li class="li">In case the <em class="ph i">keep-alive</em> was sent, and is still in the waiting interval,
                    then the real SNR is on hold till the acknowledgment is received for the
                        <em class="ph i">keep-alive</em>. The real SNR is sent upon receiving the
                    acknowledgment.</li>

                <li class="li">If an unknown session is received, then the real SNR is not sent, and the
                    session is removed.</li>

            </ol>

        </div>

        <div class="section" id="sy_n28_keep_alive_notifications_and_message_throttling__section_g41_k32_ypb"><h2 class="title sectiontitle">SNR throttling for external server (PCRF/PCF)</h2>
            
            <ol class="ol" id="sy_n28_keep_alive_notifications_and_message_throttling__ol_iwb_l32_ypb">
                <li class="li">To enable the SNR throttling:<ul class="ul" id="sy_n28_keep_alive_notifications_and_message_throttling__ul_dyp_pqw_z4b">
                        <li class="li">Set the application preference <em class="ph i">Enable SNR Throttling and Keep
                                Alive</em> to <var class="keyword varname">true</var>.</li>

                        <li class="li">In outbound configuration, configure parameters <strong class="ph b">Max Queue Size for
                                Throttling</strong>, <strong class="ph b">Throttle Interval (ms)</strong>, and <strong class="ph b">Throttling
                                Limit</strong> (SNRs to be sent in the <strong class="ph b">Throttle Interval (ms)</strong>)
                            with a non-zero value.</li>

                    </ul>
</li>

                <li class="li"> Configurable number of tokens (<strong class="ph b">Throttling Limit</strong>) are generated at a
                    predefined interval (<strong class="ph b">SNR Throttle Interval</strong>).</li>

                <li class="li">All SNRs generated by the application server are inserted into the FIFO
                    queue.</li>

                <li class="li">Before sending the SNR, it is checked whether SNR throttling is enabled or
                    not.</li>

                <li class="li">If the throttling is enabled, the SNR is retrieved and removed from the head of
                    the queue. After checking for the token availability, the SNR is sent to Policy
                    when a token is available. Thereby reducing the token count for that
                    interval.</li>

                <li class="li">If a token is not available, it waits for a predefined time for the token
                    availability.</li>

                <li class="li">There are two queues for SNR throttling:<ul class="ul" id="sy_n28_keep_alive_notifications_and_message_throttling__ul_prl_hm3_xpb">
                        <li class="li">SNRs (4G)</li>

                        <li class="li"><var class="keyword varname">NCHF_SpendingLimitControl_Notify</var></li>

                    </ul>
</li>

                <li class="li">There are separate throttling configurations for 5G and 4G. Separate tokens are
                    maintained for SNR and NCHF calls.</li>

            </ol>

            <p class="p"><strong class="ph b">Separate throttle limits for Sy and
                    <var class="keyword varname">Nchf_SpendingLimitControl</var></strong></p>

            <p class="p">Separate throttling parameters are present for <em class="ph i">Diameter Sy SNR</em> and
                    <var class="keyword varname">Nchf_SpendingLimitControl notifications</var>.</p>

        </div>

        <div class="section" id="sy_n28_keep_alive_notifications_and_message_throttling__section_bkr_kn2_ypb"><h2 class="title sectiontitle">EDRs</h2>
            
            <p class="p">The parameter <span class="ph uicontrol">Generate SNR CDR</span> is used to specify whether EDR
                should be generated after sending SNR or after receiving SNA.</p>

            <p class="p">Following configurations are required to generate SNR EDR for Sy and N28
                    <em class="ph i">keep-alive</em> notifications:</p>

            <ul class="ul" id="sy_n28_keep_alive_notifications_and_message_throttling__ul_l5z_h42_ypb">
                <li class="li">Set the application preference <em class="ph i">OCS Sy CDR Generation</em> to
                        <var class="keyword varname">true</var>.</li>

                <li class="li">Set the application preference <em class="ph i">Enable SNR Throttling and Keep Alive</em> to
                        <var class="keyword varname">true</var>.</li>

            </ul>

            <p class="p">Following are some scenarios when EDR is generated:</p>

            <p class="p"><strong class="ph b">Each SNR</strong></p>

            <p class="p">If the value of <strong class="ph b">Generate CDR SNR</strong> is <var class="keyword varname">Each SNR</var>, then for all
                scenarios, EDR is generated immediately after sending SNR. If while sending SNR,
                    <var class="keyword varname">NoRouteToHostException</var> exception is received, then
                SY_SNR_CALL_NOK, recordEventResult (04) is sent. Else, for all the other scenarios,
                SY_SNR_CALL_OK, recordEventResult (03) is sent irrespective of the resultCode
                received in SNA.</p>

            <p class="p"><strong class="ph b">SNA success</strong></p>

            <p class="p">EDR is generated if the received SNA is successful. SY_SNR_CALL_OK, recordEventResult
                (03) is generated in this scenario.</p>

            <p class="p"><strong class="ph b">Error result code or a timeout received in SNA on maximum consecutive
                retries</strong></p>

            <p class="p">EDR is not generated on every SNR failure but only when an error or timeout is
                received on reaching max consecutive retires. The recordEventResult contains the
                diameter result code received in SNA for an error scenario. The recordEventResult
                contains SY_SNA_TIMEOUT, recordEventResult(28) for timeout scenario.</p>

            <p class="p"><strong class="ph b">Skip retry</strong></p>

            <p class="p">EDR is generated if a diameter result code is received in SNA that is present in
                    <strong class="ph b">Result Codes to Skip Retry</strong> list. The recordEventResult contains the
                diameter result code received in SNA.</p>

            <p class="p"><strong class="ph b">Remove Sy session</strong></p>

            <p class="p">EDR is generated if a diameter result code is received in SNA that is present in
                    <strong class="ph b">Result Codes to Remove Session</strong>. The recordEventResult contains the
                diameter result code received in SNA.</p>

            <p class="p"><strong class="ph b">SNR queue full and throttling</strong></p>

            <p class="p">EDR is generated if the SNR is dropped because the SNR queue is full or due to
                throttling. In these cases, because SNR is never sent, SNA is never received. The
                recordEventResult is 29 for queue full and 30 for throttling.</p>

            <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> For information about result codes, refer to <em class="ph i">CDR/EDR Reference</em>.</div>

        </div>

        <div class="section" id="sy_n28_keep_alive_notifications_and_message_throttling__section_tlk_3n2_ypb"><h2 class="title sectiontitle">Alarm generation</h2>
            
            <ul class="ul" id="sy_n28_keep_alive_notifications_and_message_throttling__ul_wpg_m1d_ypb">
                <li class="li">
                    <p class="p">Alarm must be generated when a real SNR is dropped because of the
                        notification send queue being full.</p>

                </li>

                <li class="li">
                    <p class="p">Alarm must be generated when a real
                            <var class="keyword varname">Nchf_SpendingLimitControl_Notification</var> is dropped
                        because of the notification send queue being full.</p>

                </li>

                <li class="li">
                    <p class="p">An alarm is generated when the queue is near to full (percentage of SNR queue
                        defined in <code class="ph codeph">Alarm on near full Queue Percentage (%) for
                        SNR</code>). It is an auto clear, and minor alarm.</p>

                </li>

            </ul>

        </div>

        <div class="section" id="sy_n28_keep_alive_notifications_and_message_throttling__section_g3c_fn2_ypb"><h2 class="title sectiontitle">Logs</h2>
            
            <p class="p">For logging information, refer to section <em class="ph i">Logs for failed real/keep-alive SNR and
                    Spending Limit Control Notify</em> in the <em class="ph i">Diameter/HTTP Configuration
                    Guide</em>.</p>

        </div>

        <div class="section" id="sy_n28_keep_alive_notifications_and_message_throttling__section_r2s_1l1_x4bc"><h2 class="title sectiontitle">Additional information</h2>
            
            <ul class="ul" id="sy_n28_keep_alive_notifications_and_message_throttling__ul_dfy_n1d_ypb">
                <li class="li">
                    <p class="p">If the same error code is configured for <em class="ph i">Skip retry</em>, and code to
                            <em class="ph i">Remove session</em>, then the configuration is considered as wrong. In
                        this case the priority is given to <em class="ph i">Skip retry</em> error codes.</p>

                </li>

                <li class="li">
                    <p class="p">To modify <span class="ph uicontrol">Max Queue Size for Throttling</span> in 4G and 5G,
                        it is necessary to restart the diameter app or the charging pod.</p>

                </li>

                <li class="li">
                    <p class="p">The default values for removing the session are 5002 (for 4G) and 404 (for
                        5G). Even if the values are not configured in the GUI, the session is
                        removed on receiving these error codes. This logic is overridden if the
                        error codes are configured in the <em class="ph i">Skip retry list</em> of 4G and 5G. Retry
                        time starts after the error codes are received, or when the SNA timeout is
                        received.</p>

                </li>

                <li class="li">
                    <p class="p">Only one instance of outbound configuration is considered. If it is deleted
                        and created again, then the throttling queue size is not initialized.</p>

                </li>

                <li class="li">
                    <p class="p">If the keep alive audit is triggered in between real SNR retry, then it is
                        dropped. Hence the keep alive retry count is not reset.</p>

                </li>

                <li class="li">If <span class="ph uicontrol">Throttling Limit</span> and <span class="ph uicontrol">Throttle Interval
                        (ms)</span> are modified, then the new values are applied only after
                    all the previously created tokens are consumed.</li>

                <li class="li"><var class="keyword varname">Pending-Policy-Counter-Information</var> AVP support is available
                    only for real SNR.</li>

                <li class="li">The value of the application preference <em class="ph i">Default Concurrent Execution Delay
                        for SNR</em> must be set to 0 (zero) for this feature.</li>

            </ul>

        </div>

    </div>
<div class="footer"><hr /><p>Charging User Guide • P556766-DN1000054947-R23.8 • 1 • <a href="../home.html">Cover</a> • ©2023 Nokia. Nokia Confidential Information • Use subject to agreed restrictions on disclosure and use.</p></div></body>
</html>