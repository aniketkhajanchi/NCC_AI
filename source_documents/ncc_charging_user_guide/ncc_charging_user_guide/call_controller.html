<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta name="copyright" content="(C) Copyright 2023" />
<meta name="DC.rights.owner" content="(C) Copyright 2023" />
<meta name="generator" content="DITA-OT" /><meta name="DC.type" content="concept" />
<meta name="DC.title" content="Call mangement" />
<meta name="prodname" content="Nokia Converged Charging" />
<meta name="version" content="Release 23.8" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="id9yz-09126-ug01-pczza-sp1-d1e18398" />
<link rel="stylesheet" type="text/css" href="../../web/css/commonltr.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/styles.min.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/common-extended.css" /><title>Call mangement</title>
<script src="../web/js/nswtc.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
<script src="../../web/css/../js/script.min.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
</head>
<body id="id9yz-09126-ug01-pczza-sp1-d1e18398">
<div class="header"><div id="feedback-link-placeholder" class="feedback-link"></div><hr /></div><h1 class="title topictitle1" id="ariaid-title1">Call mangement</h1>
<div class="body conbody">
        <p class="p">When the NCC call controller receives an <em class="ph i">Event</em>, <em class="ph i">Initial</em>, <em class="ph i">Update</em>, or
                <em class="ph i">Terminate</em> Diameter request, it interacts with other NCC modules.</p>

        <p class="p">Call controller contains the logic to be executed on receiving an incoming Diameter
            request. The logic does not depend on the external protocol that triggered the
            request.</p>

        <p class="p">Call controller provides the interface to the network for different Diameter requests and
            responses that interface with other NCC modules. It accepts the initial attachment from
            the gateways and performs the following functions:</p>

        <ul class="ul" id="id9yz-09126-ug01-pczza-sp1-d1e18398__ul_wyl_xbb_55b">
            <li class="li">Interfaces with the subscriber model to get the device and its lifecycle.</li>

            <li class="li">Creates, modifies, and terminates a Gy session.</li>

            <li class="li">Sends a request object to the charging or rating engine.</li>

            <li class="li">Processes all Credit-Control-Request (CCR) and outgoing Credit-Control-Answer (CCA)
                messages.</li>

            <li class="li">Generates an alarm for call controller.</li>

        </ul>

        <p class="p">When a Diameter CCR is received, call controller retrieves the
                <span class="ph uicontrol">subscriptionId</span> and uses it to query the subscriber model for
            the device and determine the existence of the device. If the device exists, then call
            controller continues the message processing. If the device is barred or not found, then
            the call is rejected.</p>

        <div class="section" id="id9yz-09126-ug01-pczza-sp1-d1e18398__section_xyl_xbb_55b"><h2 class="title sectiontitle">Online data call charging</h2>
            
            <p class="p">NCC performs online (or real-time) charging and rating over the Ro and Gy interfaces,
                along with hosting duties and managing user account information and rating plans. An
                account, located in an online charging system, is queried prior to the granting of
                permission for use of the requested network resources allowing the network to
                perform real-time monitoring of resource usage and detection of the relevant
                chargeable events.</p>

            <p class="p">Based on the 3GPP TS 32.299 Ro specifications for all Diameter charging details, NCC
                supports the following three charging modes for online charging of data calls for
                IMS, SMS, MMS, and PS domains:</p>

            <ul class="ul" id="id9yz-09126-ug01-pczza-sp1-d1e18398__ul_yyl_xbb_55b">
                <li class="li">Immediate Event Charging (IEC); also known as immediate debit</li>

                <li class="li">Event Charging with Unit Reservation (ECUR); also known as two-step debit</li>

                <li class="li">Session Charging with Unit Reservation (SCUR); also known as quota-based
                    charging</li>

            </ul>

            <p class="p">Intended for the transport of charging events, the Rf and the Ro are reference points
                from the Charging Trigger Function (CTF) to the Charging Data Function (CDF) and the
                Online Charging Function (OCF) respectively. NCC communicates with the external
                entities over the Ro interface for charging requests when triggered by a domain,
                service node, or sub-system as shown in the following diagram.</p>

            <div class="fig fignone" id="id9yz-09126-ug01-pczza-sp1-d1e18398__chargingmoduleinterfaces"><span class="figcap"><span class="fig--title-label">Figure: </span>Charging module interfaces</span>
                
                <img class="image break" id="id9yz-09126-ug01-pczza-sp1-d1e18398__image_zyl_xbb_55b" src="../images/img9yz-09126-ug01-pczza-sp1-charging_modules_default.png" />
            </div>

            <p class="p">The data service receives a charging request from an external entity through the
                Diameter interface. Data charging is managed according to the parameters contained
                in the request and includes the following capabilities:</p>

            <ul class="ul" id="id9yz-09126-ug01-pczza-sp1-d1e18398__ul_azl_xbb_55b">
                <li class="li">Charging according to the event or content accessed (event charging), such as an
                    MMS.</li>

                <li class="li">Charging according to the volume of data exchanged (volume charging).</li>

                <li class="li">Charging according to the duration of the GRPS session (duration charging).</li>

                <li class="li">Charging according to the <em class="ph i">CC-Money</em> AVP not sent by the client.</li>

                <li class="li">Device-based charging (prepaid or postpaid).</li>

                <li class="li">QoS adaptation and charging based on policy rules.</li>

            </ul>

            <p class="p">The data charging function (charging mode) supports session-based and event-based
                charging modes and requests.</p>

            <ul class="ul" id="id9yz-09126-ug01-pczza-sp1-d1e18398__ul_bzl_xbb_55b">
                <li class="li">Session-based requests</li>

                <li class="li">Event-based requests</li>

            </ul>

            <p class="p">Event-based charging is performed either by immediate debit or in a two-step mode as
                follows:</p>

            <ul class="ul" id="id9yz-09126-ug01-pczza-sp1-d1e18398__ul_czl_xbb_55b">
                <li class="li">In immediate debit mode, the external entity indicates the origin, the
                    destination, the service identifier, and the requested units (amount of money),
                    if known. NCC provides the external entity with the information mentioning
                    whether the immediate debit request is granted or not.</li>

                <li class="li">In the two-step debit mode, there is firstly a credit reservation request
                    (CCR-I), where the request is units are reserved and then second request if for
                    commit (CCR-T), where there is a debit from account.<p class="p">CCR-t is received by NCC
                        only if the granted units are consumed or Validity-Timer expires.</p>
</li>

            </ul>

            <p class="p">Session-based charging allows you to request a certain amount of "quota", such as a
                certain volume for a specific URL or a certain amount of time for a video session.
                This type of charging is based on allocation of volume, duration, or specialized
                units slice(s). Volume/duration slice allocation is performed as follows:</p>

            <ul class="ul" id="id9yz-09126-ug01-pczza-sp1-d1e18398__ul_dzl_xbb_55b">
                <li class="li">The external entity sends a request to the data charging function to book a
                    volume and / or duration and or / specialized units slice(s).<div class="note" id="id9yz-09126-ug01-pczza-sp1-d1e18398__note_vdd_2ww_p5b"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> The volume, time, unit, or money reservation is
                        supported only for a single request. Multiple types of unit reservation,
                        such as volume + time per volume + units is not supported.</div>
</li>

                <li class="li">The data charging function performs a slice price according to the parameters
                    included in the request and the parameters hosted in the accounts and then books
                    a slice.</li>

                <li class="li">A transaction acknowledgement is sent to the external entity.</li>

            </ul>

            <p class="p">The operator selects whether the data charging function determines the volume,
                duration, money, or slice size (auto-determination), or whether this is done by the
                external entity.</p>

            <p class="p">The debit function enables the debit of an end-user account. For direct debiting with
                IEC, a single transaction is created where the OCF deducts a specific amount from
                the user's account immediately after completing the credit authorization. After
                receiving the authorization, the CTF delivers services. This form of credit
                authorization is a one-time event in which no session state is maintained. With IEC,
                the online charging client implements the “CLIENT, EVENT BASED” state machine
                described in IETF RFC 4006.</p>

            <p class="p">The debit may be performed in one step (immediate debit) or two steps (debit with
                confirmation of the end-user) according to the type of transaction.</p>

        </div>

        <div class="section" id="id9yz-09126-ug01-pczza-sp1-d1e18398__section_ezl_xbb_55b"><h2 class="title sectiontitle">Call control credit request profile configuration </h2>
            
            <p class="p">NCC supports call controller configuration from the credit request profile, which is
                made up of rules, default actions, and the dynamically generated information from
                request messages. Each transaction is processed in the active Rule System Version
                (RSV) as follows:</p>

            <ul class="ul" id="id9yz-09126-ug01-pczza-sp1-d1e18398__ul_fzl_xbb_55b">
                <li class="li">Rules: generated from the credit request profile executed by the Rule
                    Engine.</li>

                <li class="li">Default actions: executed only if a similar action is not executed in the
                    selected rule.</li>

                <li class="li">A list of rule tables used for call controller to set conditions and retrieve
                    actions.</li>

            </ul>

            <p class="p">Based on the object evaluated and location in the call flow, source contexts vary.
                For example, the Credit Request Profile is evaluated first in the flow. It has
                access to device and the Gy.Message context only. When the applicability condition
                or tariff is evaluated, there is access to more contexts.</p>

            <p class="p">The default RSV and default credit request profile provide an out-of-box solution for
                customizing the credit request profile. The following table describes the call
                controller default credit request profile parameters. Each parameter can have a
                default value that is automatically provisioned when no provisioning is present. </p>

            <table cellpadding="4" cellspacing="0" summary="" id="id9yz-09126-ug01-pczza-sp1-d1e18398__table_gzl_xbb_55b" class="table" width="100%" frame="border" border="1" rules="all"><colgroup><col style="width:23.474178403755868%" /><col style="width:38.262910798122064%" /><col style="width:38.262910798122064%" /></colgroup><thead class="thead" style="text-align:left;">
                        <tr class="row">
                            <th class="entry cellrowborder" style="vertical-align:top;" id="d136362e229">Parameter</th>

                            <th class="entry cellrowborder" style="vertical-align:top;" id="d136362e232">Description</th>

                            <th class="entry cellrowborder" style="vertical-align:top;" id="d136362e235">Value</th>

                        </tr>

                    </thead>
<tbody class="tbody">
                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e229 ">profileName</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e232 ">The name of the default profile.</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e235 ">The default Credit Request Profile is named “Default”</td>

                        </tr>

                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e229 ">priority</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e232 ">The priority in the default Credit Request Profile is set to the
                                lowest priority, which is the largest number of the type
                                Integer.</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e235 ">Integer</td>

                        </tr>

                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e229 ">isActive</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e232 ">This parameter exists in the default Credit Request Profile to
                                show its status.</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e235 ">true</td>

                        </tr>

                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e229 ">defaultActions</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e232 ">
                                <p class="p">You can create two default rule variables (one for CallType and
                                    one for CallSubType) when you create the default charging rule
                                    system version (with RSV name 'default'). The rule logic for the
                                    rule variables is empty and left for you to provision their
                                    evaluation and set the values of the variables. </p>

                                <p class="p">The default actions here exist for the rule variables that you
                                    create.</p>

                                <p class="p">Other default actions or values can be added to this default
                                    profile when needed.</p>

                            </td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e235 ">
                                <p class="p">Action:
                                    Call_Result.Call-Type=Variables.get_variable("CallType")</p>

                                <p class="p">Action:
                                    Call_Result.Call-Sub-Type=Variables.get_variable("CallSubType")</p>

                            </td>

                        </tr>

                    </tbody>
</table>

            <div class="note" id="id9yz-09126-ug01-pczza-sp1-d1e18398__note_hzl_xbb_55b"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> These entity parameters cannot be changed and are valid for
                Internal purposes only. It is not exposed in the SM GUI for operators.</div>

            <p class="p">When there is a charging rule system version reload, the creditRequestProfieScanner
                checks to see if the default CreditRequestProfile exists. If it does not exist, then
                it creates the default CreditRequestProfile.</p>

            <p class="p">The following table describes what can be provisioned for call controller using a
                call control Credit Request Profile. Many of the parameters are optional to
                provision; however, each parameter can have a default value that is automatically
                provisioned when no provisioning is present. </p>

            <table cellpadding="4" cellspacing="0" summary="" id="id9yz-09126-ug01-pczza-sp1-d1e18398__table_izl_xbb_55b" class="table" width="100%" frame="border" border="1" rules="all"><caption><span class="tablecap"><span class="table--title-label">Table: </span>Call control credit request profile</span></caption><colgroup><col /><col /><col /><col /></colgroup><thead class="thead" style="text-align:left;">
                        <tr class="row">
                            <th class="entry cellrowborder" style="vertical-align:top;" id="d136362e336">Parameter</th>

                            <th class="entry cellrowborder" style="vertical-align:top;" id="d136362e339">Type</th>

                            <th class="entry cellrowborder" style="vertical-align:top;" id="d136362e342">Description</th>

                            <th class="entry cellrowborder" style="vertical-align:top;" id="d136362e345">
                                <p class="p">Mandatory/Optional </p>

                            </th>

                        </tr>

                    </thead>
<tbody class="tbody">
                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e336 ">profileName</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e339 ">String</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e342 ">A unique name of the profile that defines the value of the
                                primary key of this table.</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e345 ">Mandatory</td>

                        </tr>

                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e336 ">priority</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e339 ">Integer</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e342 ">
                                <p class="p">The priority of this profile, whose value is also unique.</p>

                                <p class="p">The priority in the default Credit Request Profile is set to the
                                    lowest priority, which is the largest number of the type
                                    Integer.</p>

                            </td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e345 ">Mandatory</td>

                        </tr>

                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e336 ">operatorName</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e339 ">String</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e342 ">The name of the operator that owns this profile.</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e345 ">Optional</td>

                        </tr>

                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e336 ">isActive</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e339 ">boolean</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e342 ">
                                <p class="p">The status of this profile. Only the active profile is used.</p>

                                <p class="p">This parameter exists in the default Credit Request Profile.</p>

                            </td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e345 ">Mandatory</td>

                        </tr>

                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e336 ">creationTime</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e339 ">Long</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e342 ">The time stamp of when this profile was created. The value is
                                automatically generated.</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e345 ">-</td>

                        </tr>

                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e336 ">lastUpdateTime</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e339 ">Long</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e342 ">The time stamp of the updated time of this profile. This value is
                                automatically generated.</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e345 ">-</td>

                        </tr>

                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e336 ">defaultZone</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e339 ">String</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e342 ">The name of the default zone used in zone processing if the
                                mapping table/rules do not yield a result.</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e345 ">Optional; however, if it is not provisioned, Rest of World (ROW)
                                is used.</td>

                        </tr>

                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e336 ">ruleTables</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e339 ">List&lt;ChargingRuleTable&gt;</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e342 ">
                                <p class="p">Contains a list of chargingRuletables.  The same action can be
                                    present in  both rule tables and defaultActions.</p>

                                <p class="p">The defaultAction has the lower priority.</p>

                                <p class="p">All rule tables in the list are automatically generated into
                                    individual rule tables in the currently active RSV.</p>

                            </td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e345 ">Optional</td>

                        </tr>

                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e336 ">defaultActions</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e339 ">List&lt;Actions&gt;</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e342 ">
                                <p class="p">Contains a list of actions used as command level action values,
                                    for example: </p>

                                <p class="p">
                                    <var class="keyword varname">CALL_RESULT.DEFAULT_ROAMING_DECISION</var>
                                </p>

                                <p class="p">
                                    <var class="keyword varname">CALL_RESULT.CREDIT_CONTROL_FAILURE_HANDLING</var>
                                </p>

                                <p class="p">
                                    <var class="keyword varname">CALL_RESULT.DIRECT_DEBITING_FAILURE_HANDLING</var>
                                </p>

                            </td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e345 ">Optional</td>

                        </tr>

                    </tbody>
</table>

            <div class="note" id="id9yz-09126-ug01-pczza-sp1-d1e18398__note_jzl_xbb_55b"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> These entity parameters cannot be changed and are valid for
                Internal purposes only. It is not exposed in the SM GUI for operators.</div>

            <p class="p">The following three rule tables are examples of rules executed using the
                    <em class="ph i">Credit-Request-Profile</em> and rule engine:</p>

            <table cellpadding="4" cellspacing="0" summary="" id="id9yz-09126-ug01-pczza-sp1-d1e18398__table_z44_2fd_v5b" class="table" frame="border" border="1" rules="all"><caption><span class="tablecap"><span class="table--title-label">Table: </span>Rule table examples</span></caption><colgroup><col style="width:15.384615384615385%" /><col style="width:84.61538461538461%" /></colgroup><thead class="thead" style="text-align:left;">
                        <tr class="row">
                            <th class="entry cellrowborder" style="vertical-align:top;" id="d136362e562">Rule table</th>

                            <th class="entry cellrowborder" style="vertical-align:top;" id="d136362e565">Rule</th>

                        </tr>

                    </thead>
<tbody class="tbody">
                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e562 ">1</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e565 ">If GY_MESSAGE.Service-Context-Id = 32274@3gpp.org Then
                                CALL_RESULT.Default-Roaming-Decision=RoamingDecision HOME</td>

                        </tr>

                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e562 ">2</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e565 ">If GY_MESSAGE.Multiple-Services-Credit-Control.Rating-Group = 8
                                Then CALL_RESULT.Call-Sub-Type = CallSubType SMS_MO</td>

                        </tr>

                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e562 ">3</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d136362e565 ">If DeviceId is in the list of
                                2000000000001|2000000000002|2000000000003 Then Call-Zones = North
                                America, Canada, Ontario</td>

                        </tr>

                    </tbody>
</table>

        </div>

        <div class="section" id="id9yz-09126-ug01-pczza-sp1-d1e18398__section_kzl_xbb_55b"><h2 class="title sectiontitle">Determining CallType and CallSubType with rule variable default actions</h2>
            
            <p class="p">Call controller resolves the CallType and CallSubType values using rule variables.
                Both the values are in common call source context and passed on to rating to allow
                manipulation of charging services. The call type and call sub-type determination are
                defined in a rule associated with the credit request profile object or in a rule
                variable.</p>

            <p class="p">Out of the box, the rule logic for the default actions mentioned in the default
                Credit Request Profile does not exist; therefore, you must configure each of the
                rule variables. You can configure a CallType instance to equal the CallType rule
                variable value and the CallSubType instance to equal the CallSubType rule variable
                value in the RSV only. Then you can use the default Credit Request Profile to use
                the rule variables. You can also configure the CallType and CallSubType rule
                variables directly as a rule action in a rule table without referencing the rule
                variable inside the Credit Request Profile.</p>

            <p class="p">If you do not configure these two rule variables, the call type determination is
                based on the 3GPP standard described below, and there is no CallSubType mapping.</p>

            <ul class="ul" id="id9yz-09126-ug01-pczza-sp1-d1e18398__ul_lzl_xbb_55b">
                <li class="li"><var class="keyword varname">SMS_SERVICE_CONTEXT_ID 32274@3gpp.org</var>: SMS call type</li>

                <li class="li"><var class="keyword varname">PS_SERVICE_CONTEXT_ID 32251@3gpp.org</var>: PS call type</li>

            </ul>

            <p class="p">Two default rule actions exist in the default ChargingRuleSystemVersion, one for
                CallType and one for CallSubType. The default CallType and CallSubType rule
                variables in the actions are empty rule variables without default values. You are
                responsible for configuring the rule variables with conditions and values. Rule
                Variable creation is described in <a class="xref" href="rules-variables.html">Rule system versions</a>.
                For example, within the default ChargingRuleSystemVersion find the default Credit
                Request Profile and use the default actions for CallType and CallSubType ensuring
                that the rule variables are configured as follows:</p>

            <ul class="ul" id="id9yz-09126-ug01-pczza-sp1-d1e18398__ul_mzl_xbb_55b">
                <li class="li">Rule Variable for CallType configured under
                        <span class="ph uicontrol">Variables</span>.<p class="p">Rule Variable Name: CallType</p>
<p class="p">Rule
                        Variable Type: ENUM </p>
</li>

                <li class="li">Rule Variable for CallSubType configured under
                        <span class="ph uicontrol">Variables</span>.<p class="p">Rule Variable Name:
                        CallSubType</p>
<p class="p">Rule Variable Type: STRING</p>
</li>

                <li class="li">Rule Set Types: GY_CREDIT_REQUEST</li>

                <li class="li">Rule Variable Evaluation</li>

            </ul>

            <p class="p">The default Credit Request Profile is configured with the lowest priority, which is
                the largest number of the type Integer. You need to clone the default
                ChargingRuleSystemVersion, and modify the default CallType and CallSubType rule
                variables, as needed, to add the evaluations with different conditions and
                values.</p>

            <div class="sectiondiv">
                <p class="p"><strong class="ph b">Example of CallType and CallSubType usage</strong></p>

                <p class="p">The following is a simple example of defining the rule logic inside the rule
                    variable CallType. In this example, you want to use AVP1 in a Gy Message to
                    determine the CallType inside the variable CallType, the rule logic can be
                    defined as follows:</p>

                <ul class="ul" id="id9yz-09126-ug01-pczza-sp1-d1e18398__ul_nzl_xbb_55b">
                    <li class="li">Rule Variable Name: CallType</li>

                    <li class="li">Description: CallType variable in Gy Message.</li>

                    <li class="li">Rule Variable Type: ENUM </li>

                    <li class="li">Rule Set Types: GY_CREDIT_REQUEST</li>

                    <li class="li">If <kbd class="ph userinput">Gy_Message.AVP1</kbd>= <var class="keyword varname">sms@abc.com</var>
                        <p class="p">then, the value is <var class="keyword varname">CallType.SMS</var>
                        </p>
</li>

                    <li class="li">If <kbd class="ph userinput">Gy_Message.AVP1</kbd>= <var class="keyword varname">ps@abc.com</var>
                        <p class="p">, then the value is <var class="keyword varname">CallType.PS</var>
                        </p>
</li>

                </ul>

                <p class="p">The following are more complex examples that define the rule logic inside the
                    rule variable CallSubType, while including the rating-group in MSCC and
                    Service-Context-Id to determine the CallSubType. For example, you can define a
                    rule in which the CallSubType rule variable is set to the value data stream or
                    SMS_MO depending on some specific values received in the Service-Context-Id and
                    the Rating-Group AVPs.</p>

                <p class="p">
                    <strong class="ph b">Complex example 1</strong>
                </p>

                <ul class="ul" id="id9yz-09126-ug01-pczza-sp1-d1e18398__ul_ozl_xbb_55b">
                    <li class="li">Rule Variable Name: CallSubType</li>

                    <li class="li">Description: CallSubType variable determination by MSCC and
                        Service-Context-Id in Gy Message.</li>

                    <li class="li">Rule Variable Type: STRING</li>

                    <li class="li">Rule Set Types: GY_CREDIT_REQUEST</li>

                    <li class="li">If <kbd class="ph userinput">Gy_Message.Service-Context-Id</kbd>=
                            <var class="keyword varname">ps@abc.com</var> AND
                            <kbd class="ph userinput">Gy_Message.Multiple-Services-Credit-Control.Rating-Group</kbd>
                        = <var class="keyword varname">2</var>
                        <p class="p">, then the value is <var class="keyword varname">dataStream</var>
                        </p>
</li>

                    <li class="li">If <kbd class="ph userinput">Gy_Message.service-Context-Id</kbd> =
                            <var class="keyword varname">sms@abc.com</var> AND
                            <kbd class="ph userinput">Gy_Message.Multiple-Services-Credit-Control.Rating-Group</kbd>
                        = <var class="keyword varname">3</var>
                        <p class="p">, then the value is <var class="keyword varname">SMS_MO</var>
                        </p>
</li>

                </ul>

                <p class="p">
                    <strong class="ph b">Complex example 2– Defining the value of CallSubType using the rule variable
                        CallType</strong>:</p>

                <ul class="ul" id="id9yz-09126-ug01-pczza-sp1-d1e18398__ul_pzl_xbb_55b">
                    <li class="li">Rule Variable Name: CallSubType</li>

                    <li class="li">Description: CallSubType variable mapped by
                        Multiple-Services-Credit-Control.Rating-Group and CallType rule variable in
                        the Gy Message.</li>

                    <li class="li">Rule Variable Type: STRING</li>

                    <li class="li">Rule Set Types: GY_CREDIT_REQUEST</li>

                    <li class="li">If Variables.get_variable <kbd class="ph userinput">callType</kbd>=
                            <var class="keyword varname">CallType.PS</var> AND
                            <kbd class="ph userinput">Gy_Message.Multiple-Services-Credit-Control.Rating-Group</kbd>
                        = <var class="keyword varname">2</var>
                        <p class="p">, then the value is <var class="keyword varname">dataStream</var>
                        </p>
</li>

                    <li class="li">If Variables.get_variable <kbd class="ph userinput">callType</kbd> =
                            <var class="keyword varname">CallType.SMS</var> AND
                            <kbd class="ph userinput">Gy_Message.Multiple-Services-Credit-Control.Rating-Group</kbd>
                        = <var class="keyword varname">3</var>
                        <p class="p">, then the value is <var class="keyword varname">SMS_MO</var>
                        </p>
</li>

                </ul>

            </div>
        </div>

        <div class="section" id="id9yz-09126-ug01-pczza-sp1-d1e18398__section_qzl_xbb_55b"><h2 class="title sectiontitle">Multiple-Services-Credit-Control</h2>
            
            <p class="p">The <em class="ph i">Multiple-Services-Credit-Control</em> AVP is of type grouped and contains the
                AVPs related to the independent credit-control of multiple services feature. Each
                instance of this AVP carries units related to one or more services or related to a
                single rating group.</p>

            <p class="p">The <em class="ph i">Service-Identifier</em> and the <em class="ph i">Rating-Group</em> AVPs associate the granted
                units to a given service or rating group. If both the <em class="ph i">Service-Identifier</em> and
                the <em class="ph i">Rating-Group</em> AVPs are included, the target of the service units is always
                the services indicated by the value of the <em class="ph i">Rating-Group</em> AVP.</p>

            <p class="p">The <em class="ph i">Requested-Service-Unit</em> AVP contains the amount of requested service units.
                If the <em class="ph i">Requested-Service-Unit</em> AVP is empty, then the reservation is done as
                per the central logic. The <em class="ph i">Requested-Service-Unit</em> AVP must be present in the
                initial interrogation and within the intermediate interrogations in which new quota
                is requested. If the credit-control client does not include the
                    <em class="ph i">Requested-Service-Unit</em> AVP in a request command (for example, if it
                determines that the end user terminated the service) then the server must debit the
                used amount from the user's account, but must not return a new quota in the
                corresponding answer. The Validity-Time and Result-Code are present in an answer
                command for graceful service termination. </p>

            <p class="p">The <em class="ph i">Multiple-Services-Control</em> AVP is defined as follows:</p>

            <div class="fig fignone" id="id9yz-09126-ug01-pczza-sp1-d1e18398__fig_rzl_xbb_55b">
                <pre class="pre codeblock" id="id9yz-09126-ug01-pczza-sp1-d1e18398__codeblock_szl_xbb_55b"><code>Multiple-Services-Credit-Control ::= &lt; AVP Header: 456 &gt;
           [ Granted-Service-Unit ]
           [ Requested-Service-Unit ]
          *[ Used-Service-Unit ]
           [ Tariff-Change-Usage ]
          *[ Service-Identifier ]
           [ Rating-Group ]
          *[ G-S-U-Pool-Reference ]
           [ Validity-Time ]
           [ Result-Code ]
           [ Final-Unit-Indication ]
          *[ AVP ]
</code></pre>
            </div>

        </div>

        <div class="section" id="id9yz-09126-ug01-pczza-sp1-d1e18398__section_ehs_p2d_v5b"><h2 class="title sectiontitle">Unit determination and rating</h2>
            
            <p class="p">This section provides information about unit determination and rating from a call
                controller perspective.</p>

            <p class="p">Rating and unit determination can be implemented as centralized (on OCF, that is
                rating or charging engine) or decentralized (on CTF, that is call controller). Unit
                determination refers to calculation of slice size to be allocated for the request
                received, such as volume, time, unit, money assigned prior to starting service
                delivery.</p>

            <p class="p"><strong class="ph b">Decentralized rating</strong></p>

            <p class="p">Rating refers to the calculation of a price out of the slice determination calculated
                by the unit determination function. For decentralized rating, the corresponding
                rating control is performed within call controller (CTF). Consequently, call
                controller (CTF) and rating or charging engine (OCF) exchange information about
                monetary units.</p>

            <p class="p"><strong class="ph b">Decentralized unit determination</strong></p>

            <p class="p">With decentralized unit determination, call controller determines how many units are
                required to start service delivery, and requests these units from rating or charging
                engine.</p>

            <p class="p">After checking the account balance of the service user, the rating or charging engine
                returns the number of granted units to call controller responsible for the
                supervision of service delivery. Call controller limits the service delivery to the
                corresponding number of granted units.</p>

            <p class="p">Currently, NCC uses decentralized unit determination for IEC, ECUR, and SCUR. Call
                controller asks rating or charging engine to assure the deduction of an amount of
                the specified number of monetary units from the subscriber account as shown in the
                following figure.</p>

            <div class="fig fignone" id="id9yz-09126-ug01-pczza-sp1-d1e18398__fig_hhs_p2d_v5b"><span class="figcap"><span class="fig--title-label">Figure: </span>IEC decentralized unit determination</span>
                
                
                <img class="image break" id="id9yz-09126-ug01-pczza-sp1-d1e18398__image_ihs_p2d_v5b" src="../images/img9yz-09126-ug01-pczza-sp1-iec_default.png" />
            </div>

            <p class="p">The request for resource usage flow is as follows:</p>

            <ol class="ol" id="id9yz-09126-ug01-pczza-sp1-d1e18398__ol_jhs_p2d_v5b">
                <li class="li">UE-A requests the desired content from the network element.</li>

                <li class="li">Units determination depends on the service requested by UE-A, call controller
                    determines the number of units accordingly.</li>

                <li class="li">Rating control has call controller calculating the number of monetary units that
                    represent the price for the number of units determined.</li>

                <li class="li">Debit units request has call controller requesting that rating or charging
                    engine assures the deduction of an amount corresponding to the calculated number
                    of monetary units from the subscriber account.</li>

                <li class="li">Account control has rating or charging engine trigger the deduction of the
                    calculated amount from the subscriber account, provided that the credit balance
                    of user is sufficient.</li>

                <li class="li">Debit units response has rating or charging engine indicating to call controller
                    the number of deducted monetary units.</li>

                <li class="li">Content service delivery has call controller delivering the content or service
                    at once, in fractions, or in individually chargeable items, corresponding to the
                    number of units as specified.</li>

                <li class="li">Credit amount control is a continuation from items 2 to 6.</li>

                <li class="li">Content service delivery continuation.</li>

                <li class="li">Session released.</li>

            </ol>

            <p class="p">For ECUR-based decentralized unit determination, call controller requests the
                reservation of units prior to service delivery. An account debit operation is
                carried out following the conclusion of service delivery as shown in the following
                figure.</p>

            <div class="fig fignone" id="id9yz-09126-ug01-pczza-sp1-d1e18398__fig_khs_p2d_v5b"><span class="figcap"><span class="fig--title-label">Figure: </span>ECUR decentralized unit determination</span>
                
                <img class="image break" id="id9yz-09126-ug01-pczza-sp1-d1e18398__image_lhs_p2d_v5b" src="../images/img9yz-09126-ug01-pczza-sp1-ecur_default.png" />
            </div>

            <p class="p">The request for resource usage flow is as follows:</p>

            <ol class="ol" id="id9yz-09126-ug01-pczza-sp1-d1e18398__ol_mhs_p2d_v5b">
                <li class="li">UE-A requests the desired content from the network element.</li>

                <li class="li">Units determination depends on the service requested by UE-A, call controller
                    determines the number of units accordingly.</li>

                <li class="li">Reserve units request where the call controller requests rating or charging
                    engine to reserve the number of units determined.</li>

                <li class="li">Rating control assisted by the rating entity has rating or charging engine
                    calculating the number of monetary units that represent the price for the number
                    of units determined.</li>

                <li class="li">Account control has the rating or charging engine check the user account balance
                    is sufficient for the requested reservation.</li>

                <li class="li">Reservation control makes the corresponding reservation in case the user account
                    balance is sufficient.</li>

                <li class="li">Reserve units response has rating or charging engine inform call controller of
                    the reserved number of units.</li>

                <li class="li">Reserved units supervision occurs simultaneously with the service delivery, call
                    controller monitors the consumption of the reserved units.</li>

                <li class="li">Content service delivery has call controller delivering the content or service
                    at once, in fractions, or in individually chargeable items, corresponding to the
                    number of units.</li>

                <li class="li">Debit units request has call controller requesting rating or charging engine to
                    assure the deduction of an amount corresponding to the consumed number of units
                    from the subscriber account. In the case that no further units are required for
                    this service, an appropriate indication triggering the release of the remaining
                    reservation is given.</li>

                <li class="li">Rating control, assisted by the rating entity has rating or charging engine
                    calculate the number of monetary units to deduct from the subscriber
                    account.</li>

                <li class="li">Account control has the rating or charging engine triggering the deduction of
                    the calculated amount from the subscriber account.</li>

                <li class="li">Debit units response has rating or charging engine informing the call controller
                    of the units actually deducted.</li>

                <li class="li">Session released.</li>

            </ol>

            <p class="p">For SCUR-based decentralized unit determination, call controller requests rating or
                charging engine to assure the reservation of an amount of the specified number of
                monetary units from the subscriber account. An account debit operation that triggers
                the deduction of the amount from the subscriber account is carried out following the
                conclusion of session establishment as shown in the following figure.</p>

            <div class="fig fignone" id="id9yz-09126-ug01-pczza-sp1-d1e18398__fig_nhs_p2d_v5b"><span class="figcap"><span class="fig--title-label">Figure: </span>SCUR decentralized unit determination</span>
                
                <img class="image break" id="id9yz-09126-ug01-pczza-sp1-d1e18398__image_ohs_p2d_v5b" src="../images/img9yz-09126-ug01-pczza-sp1-scur_default.png" />
            </div>

            <p class="p">The request for resource usage flow is as follows:</p>

            <ol class="ol" id="id9yz-09126-ug01-pczza-sp1-d1e18398__ol_phs_p2d_v5b">
                <li class="li">UE-A requests the session establishment from call controller.</li>

                <li class="li">Units determination depends on the requested type by UE-A, call controller
                    determines the number of units accordingly.</li>

                <li class="li">Rating control has call controller calculating the number of monetary units that
                    represent the price for the number of units determined.</li>

                <li class="li">Reserve units request where call controller requests rating or charging engine
                    to assure the reservation of an amount corresponding to the calculated number of
                    monetary units from the subscriber account.</li>

                <li class="li">Account control has rating or charging engine to check the user account balance
                    is sufficient for the requested reservation.</li>

                <li class="li">Reservation control makes the corresponding reservation whether the user credit
                    balance is sufficient.</li>

                <li class="li">Reserve units response has rating or charging engine to inform call controller
                    of the reserved number of monetary units.</li>

                <li class="li">Budget control has call controller monitor the consumption of the granted amount
                    simultaneously with the ongoing session. </li>

                <li class="li">Session ongoing has call controller maintain the session. One or more debit and
                    reserve operations are performed when the session is ongoing.</li>

                <li class="li">Session released.</li>

                <li class="li">Debit units request where call controller requests rating or charging engine to
                    assure the deduction of an amount corresponding to the consumed number of
                    monetary units from the subscriber account.</li>

                <li class="li">Account control has the rating or charging engine trigger the deduction of the
                    consumed amount from the subscriber account.</li>

                <li class="li">Debit units response has rating or charging engine indicate the number of
                    deducted monetary units to call controller.</li>

            </ol>

            <p class="p"><strong class="ph b">Centralized rating</strong></p>

            <p class="p">Rating refers to the calculation of a price out of the non-monetary units calculated
                by the unit determination function. With centralized rating, call controller (CTF)
                and rating or charging engine (OCF) exchange information about non-monetary units.
                Rating or charging engine (OCF) translates these units into monetary units.</p>

            <p class="p">Three cases for online charging can be distinguished as follows:</p>

            <ul class="ul" id="id9yz-09126-ug01-pczza-sp1-d1e18398__ul_whs_p2d_v5b">
                <li class="li">Immediate event charging (IEC)</li>

                <li class="li">Event charging with unit reservation (ECUR)</li>

                <li class="li">Session charging with unit reservation (SCUR)</li>

            </ul>

            <p class="p"><strong class="ph b">Centralized unit determination</strong></p>

            <p class="p">With centralized unit determination, OCF determines the number and type of units that
                a user can consume. In this approach, the unit determination is based on the rule
                defined in the credit request profile. </p>

            <p class="p">When the call controller receives the CCR-I request, if the RSU is empty and
                centralized charging mode is set, then NCC checks whether a rule is configured for
                this CCR service context in the credit request profile. If a rule is configured, the
                result action of the rule determines the unit for the call. This information is sent
                to the rating engine, where the charging services are filtered based on the unit
                type. The identified unit type and charging mode are saved in the database and used
                for the subsequent reservation requests. If a rule is not configured, then a default
                value of <var class="keyword varname">UnitType.TVOL</var> is used for the call. Note that, it is not
                possible to switch between the charging modes (centralized/decentralized) in the
                same session. </p>

            <div class="note" id="id9yz-09126-ug01-pczza-sp1-d1e18398__note_rhs_p2d_v5b"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> The centralized unit determination is not applicable for IEC
                calls.</div>

            <p class="p">For ECUR-based centralized unit determination, call controller (CTF) requests rating
                or charging engine (OCF) to reserve units based on the service identifier sent by
                call controller (CTF).</p>

            <p class="p">For SCUR-based centralized unit determination, call controller (CTF) requests rating
                or charging engine (OCF) to reserve units based on the session identifiers sent by
                call controller (CTF).</p>

            <div class="fig fignone" id="id9yz-09126-ug01-pczza-sp1-d1e18398__fig_shs_p2d_v5b"><span class="figcap"><span class="fig--title-label">Figure: </span>SCUR centralized unit determination - CCR-I</span>
                
                <img class="image break" id="id9yz-09126-ug01-pczza-sp1-d1e18398__image_ths_p2d_v5b" src="../images/img9yz-09126-ug01-pczza-sp1-scur_ccri_default.png" />
            </div>

            <p class="p">The CCR-I request for resource usage flow is as follows: </p>

            <ol class="ol" id="id9yz-09126-ug01-pczza-sp1-d1e18398__ol_uhs_p2d_v5b">
                <li class="li">UE-A (it can be a Diameter client) sends a CCR-I message to NCC node with an
                    empty RSU.</li>

                <li class="li">The call controller (CTF) checks whether the RSU is empty and sets the charging
                    mode to <var class="keyword varname">centralized</var> and retrieves the unit type from the
                    credit request profile.</li>

                <li class="li">Call controller (CTF) sends the request to rating or charging engine (OCF) to
                    add the unit type value.</li>

                <li class="li">Rating or charging engine (OCF) retrieves the subscription details for the
                    device that returns bundles. It filters the charging service using the unit type
                    and sorts charging services from bundles. Rating or charging engine (OCF)
                    executes the applicability conditions applicable for the call and gets the
                    tariff to be applied and sends the response to call controller (CTF) with the
                    results of granted units. The unit type identified and the charging mode are
                    saved to be used for further reservation requests.</li>

                <li class="li">Call controller (CTF) sends the CCA message to UA-E.</li>

            </ol>

        </div>

    </div>
<div class="footer"><hr /><p>Charging User Guide • P556766-DN1000054947-R23.8 • 1 • <a href="../home.html">Cover</a> • ©2023 Nokia. Nokia Confidential Information • Use subject to agreed restrictions on disclosure and use.</p></div></body>
</html>