<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta name="copyright" content="(C) Copyright 2023" />
<meta name="DC.rights.owner" content="(C) Copyright 2023" />
<meta name="generator" content="DITA-OT" /><meta name="DC.type" content="concept" />
<meta name="DC.title" content="On-demand session index audit" />
<meta name="prodname" content="Nokia Converged Charging" />
<meta name="version" content="Release 23.8" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="on_demand_session_index_audit" />
<link rel="stylesheet" type="text/css" href="../../web/css/commonltr.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/styles.min.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/common-extended.css" /><title>On-demand session index audit</title>
<script src="../web/js/nswtc.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
<script src="../../web/css/../js/script.min.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
</head>
<body id="on_demand_session_index_audit">
<div class="header"><div id="feedback-link-placeholder" class="feedback-link"></div><hr /></div><h1 class="title topictitle1" id="ariaid-title1">On-demand session index audit</h1>
<div class="body conbody">
        <p class="p">NCC performs a durable-delete whenever a record is deleted from the Aerospike database.
            This feature prevents deleted records from reappearing after a database node
            restart.</p>

        <ul class="ul">
            <li class="li">The downside of non-durable deleting these records is that some of the records can
                come back on a database pod restart. These records are called orphan lookups because
                there is no session entity for them in the club record. The session IDs are unique.
                Therefore, the records that came back will not interfere with the new and ongoing
                sessions. The database fills up over a period of time with these unused
                records.</li>

            <li class="li">The orphan session lookup records are cleaned by an on-demand scan job that is
                triggered via a REST API.</li>

            <li class="li">A REST API on the ME scans the session indexes to determine if the index is valid
                (for example, the session associated with the index is alive). If not, the index is
                cleaned.</li>

            <li class="li">The REST API is exposed on the provisioning pods.</li>

            <li class="li">When executed, the API starts a job and returns back with a 200 OK response and an
                    <code class="ph codeph">in progress</code> message.</li>

            <li class="li">Every index record returned by the scan is used to check the existence of the
                session in DynamicData. The session is read by using the service layer read methods
                and passing the <code class="ph codeph">session-id||club-id</code> as the input to the read
                method. The service layer methods lock the club record before reading the club -
                this is important. If the session is not present, the index is deleted. The index is
                deleted by using non-durable deletes. If there is a timeout or an exception reading
                the session from DynamicData, the index is not removed.</li>

            <li class="li">By default, only the primary partition of the site is scanned for session indexes.
                This API also provides options to scan other secondary/tertiary partitions that are
                installed on the site.</li>

            <li class="li">The execution of the on-demand index scanning job does not depend on the
                system-preference <code class="ph codeph">Disable durable delete for session indexes</code>.</li>

        </ul>

        <table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><caption><span class="tablecap"><span class="table--title-label">Table: </span>REST API parameters</span></caption><colgroup><col style="width:20%" /><col style="width:20%" /><col style="width:40%" /><col style="width:20%" /></colgroup><thead class="thead" style="text-align:left;">
                    <tr class="row">
                        <th class="entry cellrowborder" style="vertical-align:top;" id="d6371e84">Parameter</th>

                        <th class="entry cellrowborder" style="vertical-align:top;" id="d6371e87">Mandatory/Optional</th>

                        <th class="entry cellrowborder" style="vertical-align:top;" id="d6371e90">Description</th>

                        <th class="entry cellrowborder" style="vertical-align:top;" id="d6371e93">Default</th>

                    </tr>

                </thead>
<tbody class="tbody">

                    <tr class="row">
                        <td class="entry cellrowborder" style="vertical-align:top;" headers="d6371e84 ">session_type</td>

                        <td class="entry cellrowborder" style="vertical-align:top;" headers="d6371e87 ">Optional</td>

                        <td class="entry cellrowborder" style="vertical-align:top;" headers="d6371e90 ">
                            <p class="p">One of 'all', 'Gy', 'Sy', 'IMS', ‘Rating’, ‘chargingSessionMap’, and
                                'terminated'.</p>

                            <p class="p">Select session lookup datasets for scanning based on type of
                                session.</p>

                            <p class="p">If 'lookup_names' is also specified, only the session indexes in
                                lookup_names with type session_type are scanned.</p>

                            
                        </td>

                        <td class="entry cellrowborder" style="vertical-align:top;" headers="d6371e93 ">all</td>

                    </tr>

                    <tr class="row">
                        <td class="entry cellrowborder" style="vertical-align:top;" headers="d6371e84 ">lookup_names</td>

                        <td class="entry cellrowborder" style="vertical-align:top;" headers="d6371e87 ">Optional</td>

                        <td class="entry cellrowborder" style="vertical-align:top;" headers="d6371e90 ">
                            <p class="p">Null or list of valid names of session lookup data sets (eg:
                                GySessionPar_id, GySession_device).</p>

                            <p class="p">The list of session lookup data set names to be scanned.</p>

                            <p class="p">If 'session_type' is also specified, only those session indexes out
                                of the list of lookup_names are scanned that belong to the
                                session_type</p>

                        </td>

                        <td class="entry cellrowborder" style="vertical-align:top;" headers="d6371e93 ">Empty List</td>

                    </tr>

                    <tr class="row">
                        <td class="entry cellrowborder" style="vertical-align:top;" headers="d6371e84 ">Partition</td>

                        <td class="entry cellrowborder" style="vertical-align:top;" headers="d6371e87 ">Optional</td>

                        <td class="entry cellrowborder" style="vertical-align:top;" headers="d6371e90 ">
                            <p class="p">One of 'primary', 'secondary', 'tertiary' or 'all'.</p>

                            <p class="p">The spspdX partition to scan for session indexes. By default, only
                                the primary partition of the site is scanned</p>

                        </td>

                        <td class="entry cellrowborder" style="vertical-align:top;" headers="d6371e93 ">primary</td>

                    </tr>

                </tbody>
</table>

        <p class="p">Use case examples:</p>

        <pre class="pre codeblock"><code>{"session_type": "chargingsessionmap","partition":"all","lookup_names":[]}
-&gt;scan and remove lookup table chargingsessionmap.
{"session_type": "all","partition":"all","lookup_names":[]} 
-&gt;scan and remove  2 rating lookups + 7 Gy/Sy/IMS lookup tables + 1 chargingsessionmap.
{"session_type": "GY","partition":"all","lookup_names":[]}  
-&gt;scan and remove all GY Lookup Tables.
{"session_type": "IMS","partition":"all","lookup_names":[]} 
-&gt;scan and remove all IMS Lokup Tables.
{"session_type": "SY","partition":"all","lookup_names":[]} 
-&gt;scan and remove all SY Lokup Tables.
{"session_type": "Rating","partition":"all"} 
-&gt;scan and remove Rating Lookup Tables.
{"session_type": "terminated","partition":"all","lookup_names":[]}
-&gt;scan and remove Gy and IMS bin from terminatedSessions table.</code></pre>
        <div class="p">Here is a list of lookup tables. <ul class="ul">
                <li class="li">GySession_device</li>

                <li class="li">GySessionPar_id</li>

                <li class="li">IMSSession_device</li>

                <li class="li">IMSSessionPar_id</li>

                <li class="li">SySession_device</li>

                <li class="li">SySessionPar_id</li>

                <li class="li">SySession_msisdn</li>

                <li class="li">Session_device</li>

                <li class="li">SessionPar_id</li>

                <li class="li">ChargingSessionMap</li>

            </ul>

        </div>

        <pre class="pre codeblock"><code>URL:
Post Request -&gt;http://&lt;Prov-Service&gt;:8080/services/SessionIndexAuditService/execute
Body: 
Example-
{
 "session_type": "gy",
 "partition":"all",
 "lookup_names":["GySession_device"]
}</code></pre>
        <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> <ul class="ul">
                <li class="li">The system preference <code class="ph codeph">Non-locking Thread Pool Names</code> contains a
                    new name (<code class="ph codeph">NON-Locking-SessionIndexAudit-Thread</code>). If the name is
                    not present in the system property, a timeout exception occurs.</li>

                <li class="li">If an audit is running on a provisioning pod, another audit is not allowed to
                    run in parallel. If another audit is submitted, this error message is displayed:
                    <pre class="pre codeblock"><code>Session Index Audit Service is Already in progress. Please wait!!</code></pre>
                </li>

                <li class="li">While the session index audit API is in execution, logs are dumped every 30
                    seconds. The logs contain the information about the count of scanned and deleted
                    indexes from a lookup table with partition.</li>

            </ul>

        </div>

    </div>
<div class="footer"><hr /><p>Operations, Administration, and Maintenance Guide • P556766-DN1000055092-R23.8 • 1 • <a href="../home.html">Cover</a> • ©2023 Nokia. Nokia Confidential Information • Use subject to agreed restrictions on disclosure and use.</p></div></body>
</html>