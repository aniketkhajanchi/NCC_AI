<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta name="copyright" content="(C) Copyright 2023" />
<meta name="DC.rights.owner" content="(C) Copyright 2023" />
<meta name="generator" content="DITA-OT" /><meta name="DC.type" content="concept" />
<meta name="DC.title" content="Lifecycle EDR aggregation" />
<meta name="prodname" content="Nokia Converged Charging" />
<meta name="version" content="Release 23.8" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="lifecycle_edr_aggregation" />
<link rel="stylesheet" type="text/css" href="../../web/css/commonltr.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/styles.min.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/common-extended.css" /><title>Lifecycle EDR aggregation</title>
<script src="../web/js/nswtc.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
<script src="../../web/css/../js/script.min.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
</head>
<body id="lifecycle_edr_aggregation">
<div class="header"><div id="feedback-link-placeholder" class="feedback-link"></div><hr /></div><h1 class="title topictitle1" id="ariaid-title1">Lifecycle EDR aggregation</h1>
<div class="body conbody">
        <p class="p">Lifecycle records sharing the same <var class="keyword varname">correlationId</var> and having a
                <var class="keyword varname">RECORD_NUMBER</var> tag are aggregated to create a single output.
            Aggregation process starts once CGF receives a lifecycle EDR with a correlation and
                <var class="keyword varname">RECORD_NUMBER</var> = 1 and ends when
                <var class="keyword varname">LfcSessionTimeout</var> is reached. </p>

    </div>
<div class="topic concept nested1" aria-labelledby="ariaid-title2" id="concept_wzf_5r5_hyb"><h2 class="title topictitle2" id="ariaid-title2">Configuring LFC aggregation node parameters in CDR streams</h2>
<div class="body conbody">
            <p class="p">For aggregation to take <span class="ph" id="concept_wzf_5r5_hyb__Int_1bzr1Z6Y">place,</span> all Lifecycle records
                should share the same correlationId and each record should have a unique
                RECORD_NUMBER. For LFC aggregation, set the following values for node
                parameters:</p>

            <ul class="ul" id="concept_wzf_5r5_hyb__ul_ay4_yn5_hyb">
                <li class="li">For CG Kafka Collector Node (Kafka input stream) <ul class="ul" id="concept_wzf_5r5_hyb__ul_nzv_ds5_hyb">
                        <li class="li">PassThrogh: no</li>

                        <li class="li">LfcSequenceNumberField: RECORD_NUMBER</li>

                        <li class="li">LfcSessionTimeout: Number of seconds that Lifecycle multiple session
                            records are kept in Redis.</li>

                    </ul>
</li>

                <li class="li">For CG Mapper Node (Business logic stream)<ul class="ul" id="concept_wzf_5r5_hyb__ul_q13_ds5_hyb">
                        <li class="li">GeneratePartialFromStart: yes</li>

                        <li class="li">RecordSequenceNumberValidation: yes<ul class="ul" id="concept_wzf_5r5_hyb__ul_cy4_yn5_hyb">
                                <li class="li">Set to <var class="keyword varname">yes</var> if getting partial outputs ordered
                                    by RECORD_NUMBER is required</li>

                                <li class="li"> Set to <var class="keyword varname">no</var>, if ordering is NOT required.
                                </li>

                            </ul>
</li>

                    </ul>
</li>

                <li class="li">CustomPartialCheckerClass: com.nokia.mc.node.cg.sps.SPSPartialChecker</li>

                <li class="li">Logic for aggregation tags can be controlled using the following parameters<ul class="ul" id="concept_wzf_5r5_hyb__ul_dzr_bs5_hyb">
                        <li class="li">lfcAccumulatedFields: This parameter defines the list of fields that are
                            accumulated during aggregation</li>

                        <li class="li">lfcFirstOccurrenceFields: This parameter defines the list of fields that
                            are generated <span class="ph" id="concept_wzf_5r5_hyb__Int_AeCW5fu3">from the</span> first occurrence.
                        </li>

                    </ul>
</li>

            </ul>

            
            <div class="note" id="concept_wzf_5r5_hyb__note_tp1_d45_hyb"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> 
                <ul class="ul" id="concept_wzf_5r5_hyb__ul_ey4_yn5_hyb">
                    <li class="li">Fields should be added to either lfcFirstOccurrenceFields or
                        lfcAccumulatedFields. If any field is added to both then it is generated
                        from the last occurrence and a warning is raised on the mapper stream.</li>

                    <li class="li">Any field that is not part of those configurations is generated from the
                        last occurrence.</li>

                </ul>

            </div>

            <p class="p">Rounding-up is disabled by default, but it can be enabled by setting CG Mapper Node
                    <span class="ph" id="concept_wzf_5r5_hyb__Int_UxllJru9">node</span> parameter <var class="keyword varname">LFCRoundingEnabled</var>
                to <var class="keyword varname">yes</var>. If rounding is enabled, the number of digits to be
                rounded can be configured with node parameter <var class="keyword varname">LFCRoundingDigits</var>,
                which has a default value of 5. <var class="keyword varname">LFCRoundingFields</var> defines the
                list of fields that have to be rounded. </p>

        </div>
</div>
<div class="topic concept nested1" aria-labelledby="ariaid-title3" id="concept_bn4_nq5_hyb"><h2 class="title topictitle2" id="ariaid-title3">Lifecycle EDR aggregation use cases</h2>
<div class="body conbody">
            <ul class="ul" id="concept_bn4_nq5_hyb__ul_fy4_yn5_hyb">
                <li class="li">Final output of a complete session (with no gaps in between based on the
                    RECORD_NUMBER) is generated after getting <var class="keyword varname">LfcSsessionTimeout</var>
                    passed.</li>

                <li class="li">Partial output generation is with no delay unless there is a missing request,
                    then partial generation stops till passing the LfcSsessionTimeout.</li>

                <li class="li">When there is a missing request, input is merged as usual, and a warning is
                    raised on the GUI showing the incomplete correlationid with the missing request
                    (start or update)</li>

                <li class="li">All the mentioned cases generate partial EDR outputs dumped into the edr
                    directory and chf-edr Kafka topic. </li>

                <li class="li">Aggregated EDRs are populated under edr/lfc/final file directory and lfc-final
                    Kafka topic. </li>

                <li class="li"><strong class="ph b">LIMITATIO</strong>N<strong class="ph b">:</strong>
                </li>

            </ul>

            <div class="note notice" id="concept_bn4_nq5_hyb__note_kjz_3gv_hyb"><div class="noticetitle"><img src="../../web/css/../images/notice.svg" title="notice-icon" class="noteicon" />Notice:</div> EDR merge works only for root-level tags.
                Lists/blocks are not populated to the merged EDR.</div>
            
            
        </div>
</div>
<div class="topic concept nested1" aria-labelledby="ariaid-title4" id="concept_zlg_lq5_hyb"><h2 class="title topictitle2" id="ariaid-title4">Aggregation rules</h2>
<div class="body conbody">
            
            <p class="p">Aggregation rules define how a single field in multiple records is aggregated to one
                field in the final output record. Basically, there are three cases which are:</p>

            <ul class="ul" id="concept_zlg_lq5_hyb__ul_gy4_yn5_hyb">
                <li class="li">Fields such as recordType should be taken from the initial request.</li>

                <li class="li">Other Fields (usually numeric) can be accumulated. </li>

                <li class="li">Fields that are not mentioned in the previous fields are taken from the last
                    update request (last occurrence). </li>

                <li class="li">invokedBy has the values of all inputs.</li>

                <li class="li">recordId is not populated in the merged output.</li>

            </ul>

            
            <table cellpadding="4" cellspacing="0" summary="" id="concept_zlg_lq5_hyb__table_hy4_yn5_hyb" class="table" frame="border" border="1" rules="all"><colgroup><col style="width:33.78378378378378%" /><col style="width:66.21621621621621%" /></colgroup><thead class="thead" style="text-align:left;">
                        <tr class="row">
                            <th class="entry cellrowborder" style="vertical-align:top;" id="d12895e216">Logic</th>

                            <th class="entry cellrowborder" style="vertical-align:top;" id="d12895e219">Fields</th>

                        </tr>

                    </thead>
<tbody class="tbody">
                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d12895e216 ">LfcFirstOccurrenceFields</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d12895e219 ">recordType, serviceProvider, triggeredEntityType,
                                triggeredEntityId, transitionName, correlationId,
                                transitionStartState, entityLifeCycleName, triggeredBy,
                                triggeredAtTime, queueId, periodicLifeCycleName, accountType,
                                accountID, timeZoneId, accountDbid, accountName, accountELCState,
                                accountPLCState, accountBalanceBefore, accountBalanceAfter,
                                previousEntityLifeCycleState, previousPeriodLifeCycleState,
                                bundleName, bundleActivationType, deviceDBId, deviceId, deviceName,
                                fee, taxationID, totalTaxAmount, taxRateApplied, discountPercentage,
                                discountOnFee, result, reason, meHostName, nccVersion</td>

                        </tr>

                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d12895e216 ">LfcAccumulatedFields</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d12895e219 ">Default configuration for this node parameter is empty</td>

                        </tr>

                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d12895e216 ">LFCRoundingFields</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d12895e219 ">Default configuration for this node parameter is empty</td>

                        </tr>

                    </tbody>
</table>

        </div>
</div>
<div class="topic concept nested1" aria-labelledby="ariaid-title5" id="concept_acp_jq5_hyb"><h2 class="title topictitle2" id="ariaid-title5">Distribution rules for aggregated and partial outputs</h2>
<div class="body conbody">
            <p class="p">LFC aggregation results in getting separated files of partial and aggregated outputs.
                Partial outputs are NCC requests populated in a generic format without any CGF (DR)
                processing.</p>

            <p class="p"> Aggregated and partial files are distributed to different destinations
                (directory/Kafka topic).</p>

            <ul class="ul" id="concept_acp_jq5_hyb__ul_iy4_yn5_hyb">
                <li class="li">Partial records are directed to edr directory and chf-edr Kafka topic.</li>

                <li class="li">Merged EDRs are segregated to a separate directory and Kafka topic.</li>

            </ul>

            <table cellpadding="4" cellspacing="0" summary="" id="concept_acp_jq5_hyb__table_gmc_b45_hyb" class="table" frame="border" border="1" rules="all"><colgroup><col /><col /><col /><col /><col /><col /></colgroup><thead class="thead" style="text-align:left;">
                        <tr class="row">
                            <th class="entry cellrowborder" rowspan="2" style="vertical-align:top;" id="d12895e297">Description</th>

                            <th class="entry cellrowborder" rowspan="2" style="vertical-align:top;" id="d12895e300">Criteria</th>

                            <th class="entry cellrowborder" rowspan="2" style="vertical-align:top;" id="d12895e303">Priority Rule</th>

                            <th class="entry cellrowborder" colspan="2" style="vertical-align:top;" id="d12895e306">Destination: File</th>

                            <th class="entry cellrowborder" style="vertical-align:top;" id="d12895e309">Destination : Kafka</th>

                        </tr>

                        <tr class="row">
                            <th class="entry cellrowborder" style="vertical-align:top;" id="d12895e315">Directory</th>

                            <th class="entry cellrowborder" style="vertical-align:top;" id="d12895e318">File Group</th>

                            <th class="entry cellrowborder" style="vertical-align:top;" id="d12895e321">Topic</th>

                        </tr>

                    </thead>
<tbody class="tbody">
                        <tr class="row">
                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d12895e297 ">Final aggregated records for LFC session</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d12895e300 ">EL_FINAL_LFC= true</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d12895e303 ">16</td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d12895e306 d12895e315 ">edr/lfc/final </td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d12895e306 d12895e318 ">.LFC.FINAL </td>

                            <td class="entry cellrowborder" style="vertical-align:top;" headers="d12895e309 d12895e321 ">lfc-final </td>

                        </tr>

                    </tbody>
</table>

        </div>
</div>
<div class="topic concept nested1" aria-labelledby="ariaid-title6" id="concept_vbh_bq5_hyb"><h2 class="title topictitle2" id="ariaid-title6">Examples of Inputs and Merged Output</h2>
<div class="body conbody">
            <div class="section" id="concept_vbh_bq5_hyb__section_ztz_2hv_hyb"><h3 class="title sectiontitle">Input</h3>
                
                <p class="p"><strong class="ph b">RECORD_NUMBER = 1</strong></p>

                <pre class="pre codeblock" id="concept_vbh_bq5_hyb__codeblock_pdv_yp5_hyb"><code>{
    "LIFECYCLE_RECORD": {
        "recordId": "20220324110447_70df8c5d-16ce-4f71-a108-4f9980082b1a",
        "serviceProvider": "MVNO1",
        "invokedBy": "ChargeFeeAction",
        "triggeredEntityType": "Subscription",
        "triggeredEntityId": "448b1a79-15b1-4666-8a4b-b4cbab6134ed",
        "transitionName": "CallActivationEvent",
        "correlationId": "X-CorrelationId:98a55cca-b055-42ce-8664-6a324ee718bc",
        "transitionStartState": "PreActive",
        "entityLifeCycleName": "DefaultSubscriptionLifeCycle",
        "triggeredBy": "EVENT",
        "triggeredAtTime": "25/05/2023 12:46:51+02:00",
        "queueId": "4",
        "periodicLifeCycleName": "BundleLC_Periodic_79568",
        "accountType": "PRE_PAID",
        "accountID": "Account3705",
        "timeZoneId": "Europe/Budapest",
        "accountDbid": "1e7a88d7-c011-4e98-b539-a272d39b76a0",
        "accountName": "Account3705",
        "accountELCState": "Active",
        "accountPLCState": "Start",
        "accountBalanceBefore": "1000.00000",
        "accountBalanceAfter": "800.00000",
        "previousEntityLifeCycleState": "Active",
        "previousPeriodLifeCycleState": "Active",
        "bundleName": "2001_TestMonthly_recurring_3GB_v2",
        "bundleActivationType": "SUBSCRIPTION_MERGE",
        "deviceDBId": "83f12046-65f9-4eb0-af22-8f8e6006a3b8",
        "deviceId": "962902207986",
        "deviceName": "962902207986",
        "fee": "9.02",
        "taxationID": "5_Percent",
        "totalTaxAmount": "98.2857144999999945866875350475311279296875",
        "taxRateApplied": "5.00000",
        "discountPercentage": "9.8",
        "discountOnFee": "0.98",
        "result": "Success",
        "reason": "0",
        "subscriptionStartDateTime": "21-02-2022 02:30:21",
        "subscriptionEndDateTime": "22-02-2022 02:30:21",
        "RECORD_NUMBER": "1",
        "timeStamp": "20-02-2022 02:30:21",
        "meHostName": "ig1;ig-recharge-768fd5bd85-sz5vz",
        "nccVersion": "SPS_23_5_R1",
        "RecordTimestamp": "20-02-2022 09:00:21",
    }
}
</code></pre>
                <p class="p"><strong class="ph b">RECORD_NUMBER = 2</strong></p>

                <pre class="pre codeblock" id="concept_vbh_bq5_hyb__codeblock_oy4_wp5_hyb"><code>{
    "LIFECYCLE_RECORD": {
        "recordId": "20230525104651_a3d1b909-ab65-4e1e-81b1-9e1c4083290a",
        "invokedBy": "ResetPeriodAction",
        "invokedMethod": "ResetPeriodAction",
        "triggeredEntityType": "Subscription",
        "triggeredEntityId": "448b1a79-15b1-4666-8a4b-b4cbab6134ed",
        "transitionName": "ChargeFeeActionSuccessEvent",
        "correlationId": "X-CorrelationId:98a55cca-b055-42ce-8664-6a324ee718bc",
        "transitionStartState": "PreActive",
        "entityLifeCycleName": "DefaultSubscriptionLifeCycle",
        "triggeredBy": "EVENT",
        "triggeredAtTime": "25/05/2023 12:46:51+02:00",
        "queueId": "4",
        "periodicLifeCycleName": "BundleLC_Periodic_79568",
        "accountType": "PRE_PAID",
        "accountID": "Account3705",
        "timeZoneId": "Europe/Budapest",
        "accountDbid": "1e7a88d7-c011-4e98-b539-a272d39b76a0",
        "accountName": "Account3705"
        "accountELCState": "Active",
        "accountPLCState": "Start",
        "accountBalanceBefore": "1000.00000",
        "accountBalanceAfter": "800.00000",
        "previousEntityLifeCycleState": "Active",
        "previousPeriodLifeCycleState": "Active",
        "billingCycleSource": "ACCOUNT",
        "activationTime": "25/05/2023 12:41:33+02:00",
        "hourOfDay": "0",
        "dayOfMonth": "1",
        "dayOfWeek": "SUNDAY",
        "bundleName": "2001_TestMonthly_recurring_3GB_v2",
        "bundleActivationType": "SUBSCRIPTION_MERGE",
        "deviceDBId": "83f12046-65f9-4eb0-af22-8f8e6006a3b8",
        "deviceId": "962902207986",
        "deviceName": "962902207986",
        "startTime": "25/05/2023 12:46:51+02:00",
        "endTime": "25/05/2023 12:48:51+02:00",
        "RECORD_NUMBER": "2",
        "timeStamp": "20-02-2022 02:30:21",
        "meHostName": "ig1;ig-recharge-768fd5bd85-sz5vz",
        "nccVersion": "SPS_23_5_R1",
        "RecordTimestamp": "20-02-2022 09:00:21"
    }
}
</code></pre>
            </div>

            <div class="section" id="concept_vbh_bq5_hyb__section_ac5_chv_hyb"><h3 class="title sectiontitle">Merged output</h3>
                
                <pre class="pre codeblock" id="concept_vbh_bq5_hyb__codeblock_lnl_vp5_hyb"><code>record1:
  payload:
    genericRecord:
      recordType: LIFECYCLE_RECORD
      recordElements:
      - varName: serviceProvider
        varValue: MVNO1
      - varName: triggeredEntityType
        varValue: Subscription
      - varName: triggeredEntityId
        varValue: 448b1a79-15b1-4666-8a4b-b4cbab6134ed
      - varName: transitionName
        varValue: CallActivationEvent
      - varName: correlationId
        varValue: X-CorrelationId:98a55cca-b055-42ce-8664-6a324ee718bc
      - varName: transitionStartState
        varValue: PreActive
      - varName: entityLifeCycleName
        varValue: DefaultSubscriptionLifeCycle
      - varName: triggeredBy
        varValue: EVENT
      - varName: triggeredAtTime
        varValue: 25/05/2023 12:46:51+02:00
      - varName: queueId
        varValue: '4'
      - varName: periodicLifeCycleName
        varValue: BundleLC_Periodic_79568
      - varName: accountType
        varValue: PRE_PAID
      - varName: accountID
        varValue: Account3705
      - varName: timeZoneId
        varValue: Europe/Budapest
      - varName: accountDbid
        varValue: 1e7a88d7-c011-4e98-b539-a272d39b76a0
      - varName: accountName
        varValue: Account3705
      - varName: accountELCState
        varValue: Active
      - varName: accountPLCState
        varValue: Start
      - varName: accountBalanceBefore
        varValue: '1000.00000'
      - varName: accountBalanceAfter
        varValue: '800.00000'
      - varName: previousEntityLifeCycleState
        varValue: Active
      - varName: previousPeriodLifeCycleState
        varValue: Active
      - varName: bundleName
        varValue: 2001_TestMonthly_recurring_3GB_v2
      - varName: bundleActivationType
        varValue: SUBSCRIPTION_MERGE
      - varName: deviceDBId
        varValue: 83f12046-65f9-4eb0-af22-8f8e6006a3b8
      - varName: deviceId
        varValue: '962902207986'
      - varName: deviceName
        varValue: '962902207986'
      - varName: fee
        varValue: '9.02'
      - varName: taxationID
        varValue: 5_Percent
      - varName: totalTaxAmount
        varValue: '98.2857144999999945866875350475311279296875'
      - varName: taxRateApplied
        varValue: '5.00000'
      - varName: discountPercentage
        varValue: '9.8'
      - varName: discountOnFee
        varValue: '0.98'
      - varName: result
        varValue: Success
      - varName: reason
        varValue: '0'
      - varName: subscriptionStartDateTime
        varValue: 21-02-2022 02:30:21
      - varName: subscriptionEndDateTime
        varValue: 22-02-2022 02:30:21
      - varName: timeStamp
        varValue: 20-02-2022 02:30:21
      - varName: meHostName
        varValue: ig1;ig-recharge-768fd5bd85-sz5vz
      - varName: nccVersion
        varValue: SPS_23_5_R1
      - varName: RecordTimestamp
        varValue: 20-02-2022 09:00:21
      - varName: invokedBy
        varValue: ChargeFeeActionAndResetPeriodAction
      - varName: invokedMethod
        varValue: ResetPeriodAction
      - varName: billingCycleSource
        varValue: ACCOUNT
      - varName: activationTime
        varValue: 25/05/2023 12:41:33+02:00
      - varName: hourOfDay
        varValue: '0'
      - varName: dayOfMonth
        varValue: '1'
      - varName: dayOfWeek
        varValue: SUNDAY
      - varName: startTime
        varValue: 25/05/2023 12:46:51+02:00
      - varName: endTime
        varValue: 25/05/2023 12:48:51+02:00
</code></pre>
            </div>

        </div>
</div>
<div class="footer"><hr /><p>CDR/EDR Reference • P556766-DN1000055014-R23.8 • 1 • <a href="../home.html">Cover</a> • ©2023 Nokia. Nokia Confidential Information • Use subject to agreed restrictions on disclosure and use.</p></div></body>
</html>