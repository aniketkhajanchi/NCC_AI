<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta name="copyright" content="(C) Copyright 2023" />
<meta name="DC.rights.owner" content="(C) Copyright 2023" />
<meta name="generator" content="DITA-OT" /><meta name="DC.type" content="task" />
<meta name="DC.title" content="Installing CCTF on OpenShift with custom SCC and service account" />
<meta name="prodname" content="Nokia Converged Charging" />
<meta name="version" content="Release 23.8" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="installing_cctf_on_openshift_custom" />
<link rel="stylesheet" type="text/css" href="../../web/css/commonltr.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/styles.min.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/common-extended.css" /><title>Installing CCTF on OpenShift with custom SCC and service account</title>
<script src="../web/js/nswtc.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
<script src="../../web/css/../js/script.min.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
</head>
<body id="installing_cctf_on_openshift_custom">
<div class="header"><div id="feedback-link-placeholder" class="feedback-link"></div><hr /></div><h1 class="title topictitle1" id="ariaid-title1">Installing CCTF on OpenShift with custom SCC and service account</h1>
<div class="body taskbody">
        <div class="section context"><div class="tasklabel"><h2 class="sectiontitle tasklabel"></h2></div>
            <p class="p">This procedure describes how to install CCTF on OpenShift with custom Security
        Context Constraints (SCC) and service account.</p>

      <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> Using SCC is optional but <em class="ph i">recommended</em> in OpenShift deployments. If custom SCC and
        service account are not used, follow the instructions given in <a class="xref" href="installation_with_istio.html">Installation with Istio</a>.</div>

        </div>

        <div class="tasklabel"><h2 class="sectiontitle tasklabel"></h2></div><ol class="ol steps"><li class="li step stepexpand">
                <span class="ph cmd">Create namespace:</span>
                <div class="itemgroup info">
                    <pre class="pre codeblock"><code>NAMESPACE=cctf
oc new-project $NAMESPACE
oc project $NAMESPACE
kubectl label namespace --overwrite=true $NAMESPACE istio-injection=enabled</code></pre>
                </div>
            </li>
<li class="li step stepexpand">
                <span class="ph cmd">Prepare YAML files for service account, role and rolebinding.</span>
                <div class="itemgroup info">
                    <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> To be able to proceed with this step, the <code class="ph codeph">cctf-scc-custom</code>
            SCC must have been created.</div>

          <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> To be able to run <code class="ph codeph">tcpdump</code> in the <code class="ph codeph">exec-env</code>
            container of the Jenkins agent pod, the following must be defined in the
              <code class="ph codeph">chf-scc-custom</code>
            SCC:<pre class="pre codeblock"><code>allowedCapabilities:
- NET_ADMIN
- NET_RAW</code></pre></div>

                </div>
                <div class="tasklabel"><h2 class="sectiontitle tasklabel"></h2></div><ol type="a" class="ol substeps" id="installing_cctf_on_openshift_custom__substeps_d5t_fl1_54b">
                    <li class="li substep substepexpand">
                        <span class="ph cmd">Create (and navigate to) a <code class="ph codeph">service-account</code>
                            directory:</span>
                        <div class="itemgroup info">
                            <pre class="pre codeblock"><code>mkdir service-account
cd service-account</code></pre>
                        </div>
                    </li>

                    <li class="li substep substepexpand">
            <span class="ph cmd">Create a <code class="ph codeph">cctf-custom-sa.yaml</code> file for service account, with the
              given content:</span>
            <div class="itemgroup info">
              <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> The rules provided here are the minimum set of rules required.</div>

              <pre class="pre codeblock"><code>cat &lt;&lt;EOF &gt; cctf-custom-sa.yaml
apiVersion: v1
kind: Role
metadata:
  name: cctf-role-external
  namespace: &lt;NAMESPACE&gt;
rules:
- apiGroups: [""]
  resources: ["pods/exec"]
  verbs: ["create", "get"]
- apiGroups: [""]
  resources: ["configmaps", "pods", "persistentvolumeclaims", "secrets"]
  verbs: ["create", "get", "watch", "list", "patch", "update", "delete"]
- apiGroups: ["apps"]
  resources: ["statefulsets"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["events"]
  verbs: ["watch"]
- apiGroups: ["batch"]
  resources: ["jobs"]
  verbs: ["get", "list", "patch", "update", "delete"]
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cctf-custom-sa
  namespace: &lt;NAMESPACE&gt;
 
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: cctf-rolebinding-external
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: cctf-role-external
subjects:
- kind: ServiceAccount
  name: cctf-custom-sa
  namespace: &lt;NAMESPACE&gt;
EOF</code></pre>
            </div>
          </li>

                    <li class="li substep substepexpand">
            <span class="ph cmd">Create a <code class="ph codeph">cctf-custom-role.yaml</code> file for role, with the given
              content:</span>
            <div class="itemgroup info">
              <pre class="pre codeblock"><code>cat  &lt;&lt;EOF &gt; cctf-custom-role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: cctf-scc-custom-role
  namespace: &lt;NAMESPACE&gt;
rules:
- apiGroups:
  - security.openshift.io
  resourceNames:
  - cctf-scc-custom
  resources:
  - securitycontextconstraints
  verbs:
  - use
EOF</code></pre>
            </div>
          </li>

                    <li class="li substep substepexpand">
            <span class="ph cmd">Create a <code class="ph codeph">cctf-custom-rb.yaml</code> file for rolebinding, with the given
              content:</span>
            <div class="itemgroup info">
              <pre class="pre codeblock"><code>cat &lt;&lt;EOF &gt; cctf-custom-rb.yaml
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: cctf-custom-rb
  namespace: &lt;NAMESPACE&gt;
subjects:
- kind: ServiceAccount
  name: cctf-custom-sa
  namespace: &lt;NAMESPACE&gt;
roleRef:
  kind: Role
  name: cctf-scc-custom-role
  apiGroup: rbac.authorization.k8s.io
EOF</code></pre>
            </div>
          </li>

                    <li class="li substep substepexpand">
                        <span class="ph cmd">Replace <code class="ph codeph">&lt;NAMESPACE&gt;</code> with the real namespace:</span>
                        <div class="itemgroup info">
                            <pre class="pre codeblock"><code>find . -type f -print | xargs grep -l "&lt;NAMESPACE&gt;" | xargs sed -i "s/&lt;NAMESPACE&gt;/$NAMESPACE/g"
 
cd ..
oc apply -R -f service-account/ -n $NAMESPACE</code></pre>
                        </div>
                    </li>

                </ol>

            </li>
<li class="li step stepexpand">
                <span class="ph cmd">Create an overrides file for CCTF.</span>
                <div class="itemgroup info">
                    <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> In the following example file
              <code class="ph codeph">cctf-openshift-overrides.yaml</code>, replace or check registry, host names
            and <code class="ph codeph">ingressPodSelector</code>.</div>

          <pre class="pre codeblock"><code>cat cctf-openshift-overrides.yaml
global:
  registry: &lt;docker registry url&gt;:5000/i111newcctf
  registry1: &lt;docker registry url&gt;:5000/i111newcctf
  registry2: &lt;docker registry url&gt;:5000/i111newcctf
  registry3: &lt;docker registry url&gt;:5000/i111newcctf
  registry4: &lt;docker registry url&gt;:5000/i111newcctf

threeButtonsAPI:
  enabled: false
storageSize: "160Gi"
cbur:
  enabled: false

resources:
# Ajust according to CCTF Pod in Table 4: CPU and memory recommendations
  limits:
    cpu: 1
   memory: 2Gi
  requests:
    cpu: 1
    memory: 2Gi

istio:
  # version of istio available in the environment, support 1.4 or &gt;=1.5
  version: 1.9
  enabled: true
  cni:
    enabled: true
  mtls:
    enabled: true
  permissive: false
  virtualservice:
    hosts:
    - 'espoo-cctf.com'
  gateway:
    # Name of the istio gateway.
    name: cctf-gw
    # Should this be enabled or not.
    enabled: true
# To change HTTPS to HTTP access, uncomment the following 2 lines:
#    port: 80
#    protocol: HTTP
    hosts:
      - 'espoo-cctf.com'
      - 'espoo-jenkins.com'
    ingressPodSelector:
      istio: cctf
# To change HTTPS to HTTP access, uncomment the following 2 lines:
#https:
#  enabled: false
serviceAccountName: cctf-custom-sa
ingress:
  enabled: false
ncd:
  enabled: false
rbac:
  enabled: false

cmdbmariadb:
  resources:
# Ajust according to DB Pod in Table 4: CPU and memory recommendations
    requests:
      memory: 768Mi
      cpu: 1
    limits:
      memory: 768Mi
      cpu: 1
  serviceAccountName: cctf-custom-sa
  mariadb:
    resources:
# Ajust according to DB Pod in Table 4: CPU and memory recommendations
      requests:
        memory: 768Mi
        cpu: 1
      limits:
        memory: 768Mi
        cpu: 1
  global:
    istioVersion: 1.9
  istio:
    enabled: true
jenkins:
 Master:
# To change HTTPS to HTTP access, uncomment the following 2 lines:
#    https:
#      enabled: false
    resources:
# Ajust according to Jenkins Master Pod  in Table 4: CPU and memory recommendations
      requests:
        cpu: 2
        memory: 2Gi
      limits:
        cpu: 2
        memory: 2Gi
    RunAsUser: 1000
    FsGroup: 1000
    Ingress:
      enabled: false
  serviceAccountName: cctf-custom-sa
  rbac:
    enabled: false
  Agent:
    resources:
# Ajust according to jnlp in Table 4: CPU and memory recommendations
      requests:
        cpu: 1
        memory: 512Mi
      limits:
        cpu: 1
        memory: 512Mi
    Image: "jnlp-slave"
  istio:
    version: 1.9
    enabled: true
    mtls:
      enabled: true
    cni:
      enabled: true
    permissive: false
    sharedHttpGateway:
      name: cctf-gw
    virtualservice:
      hosts:
      - 'espoo-jenkins.com'
timezone:
  mountHostLocaltime: false
</code></pre>
                </div>
            </li>
<li class="li step stepexpand">
        <span class="ph cmd">Install CCTF, with the values defined in the overrides file:</span>
        <div class="itemgroup info">
          <pre class="pre codeblock"><code>helm upgrade --install cctf -f cctf-openshift-overrides.yaml cctf-&lt;version&gt;.tgz -n $NAMESPACE</code></pre>
        </div>
      </li>
</ol>

    </div>
<div class="footer"><hr /><p>DevOps Guide • P556766-DN1000055058-R23.8 • 1 • <a href="../home.html">Cover</a> • ©2023 Nokia. Nokia Confidential Information • Use subject to agreed restrictions on disclosure and use.</p></div></body>
</html>