<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta name="copyright" content="(C) Copyright 2023" />
<meta name="DC.rights.owner" content="(C) Copyright 2023" />
<meta name="generator" content="DITA-OT" /><meta name="DC.type" content="concept" />
<meta name="DC.title" content="CG Kafka Distributor Node" />
<meta name="prodname" content="Nokia Converged Charging" />
<meta name="version" content="Release 23.8" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="cg_kafka_distributor_node" />
<link rel="stylesheet" type="text/css" href="../../web/css/commonltr.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/styles.min.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/common-extended.css" /><title>CG Kafka Distributor Node</title>
<script src="../web/js/nswtc.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
<script src="../../web/css/../js/script.min.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
</head>
<body id="cg_kafka_distributor_node">
<div class="header"><div id="feedback-link-placeholder" class="feedback-link"></div><hr /></div><h1 class="title topictitle1" id="ariaid-title1">CG Kafka Distributor Node</h1>
<div class="body conbody">
        <p class="p">CG Kafka Distributor Node sends ASN.1 encoded records to Apache Kafka brokers. The Apache
            Kafka topics, to which the records are stored, are defined by distribution rules (see
                <a class="xref" href="overview_distribution_rules.html#SPS_CDR_Streams_Stream_Overview_distribution_rules">Distribution rules</a>). Unless automatic creation of topics is enabled in the Kafka brokers configuration,
            the necessary topics must be created in advance. In addition to the Apache Kafka topics
            defined in distribution rules, the node requires topics specified in node parameters
                <code class="ph codeph">KafkaDefaultTopicName</code> and
                <code class="ph codeph">KafkaTransactionHistoryTopic</code>.</p>

        <div class="section" id="cg_kafka_distributor_node__section_or1_sl5_pnb"><h2 class="title sectiontitle">Distribution to Kafka topics</h2>
            
            <p class="p">Two Kafka clusters can be configured as the destination for the distributed records.
                Each can have a list of broker endpoints, which are configured with mandatory node
                parameter <code class="ph codeph">BootstrapServers</code> for the primary cluster, and optional
                node parameter <code class="ph codeph">SecondaryBootstrapServers</code> for the backup cluster. In
                case the primary Kafka cluster is down, and a secondary Kafka cluster has been
                configured, the secondary cluster will be used as backup destination for the records
                that fail to be acknowledged on the primary cluster. </p>

            <p class="p">CG Kafka Distributor Node uses an idempotent Apache Kafka producer, which guarantees
                that a message is delivered exactly once. Messages are sent in parallel, and node
                parameter <code class="ph codeph">KafkaMaxRecordsInFlight</code> specifies the maximum number of
                records in flight. The number of retries (maps to the Apache Kafka producer property
                "retries") can be set in node parameter <code class="ph codeph">KafkaRetriesCount</code>. Other
                Apache Kafka producer properties can be configured in node parameter
                    <code class="ph codeph">KafkaProducerExtraProperties</code> in the format
                    <code class="ph codeph">"key1=value1,key2=value2"</code>.</p>

            <p class="p">If CG Kafka Distributor Node fails while processing a batch of records, another
                instance of a Kafka output stream will reattempt to deliver the records after the
                timeout for batch processing has expired. To prevent recurrent delivery of already
                distributed records, the node sends each batch of records as a Kafka transaction. In
                addition to the records themselves, a transaction includes a batch identifier
                message, which is sent to the topic defined in node parameter
                    <code class="ph codeph">KafkaTransactionHistoryTopic</code>. The offset of the batch
                identifier message is stored in the database.</p>

            <p class="p">Before sending a batch of records to Kafka brokers, CG Kafka Distributor Node
                verifies if the corresponding batch offset in the database is empty. If the offset
                is not empty, the node checks if a batch identifier message has been committed
                earlier. If the message has been committed (meaning that another node has already
                sent the batch successfully), the node marks the batch as fully distributed and
                deletes the data in the database. If, on the other hand, the offset in the database
                is empty or the batch identifier message has not been committed, the node begins a
                new transaction and sends the data together with the batch identifier message to
                Kafka brokers. Before committing the transaction, the node saves the offset of the
                batch identifier message to the database. To prevent an unlikely concurrent
                modification, the offset is saved in an atomic compare-exchange operation, which
                only succeeds if the earlier observed offset has not been modified. If the offset
                has been modified, the node aborts the transaction. Otherwise, it commits the
                transaction, removes the batch and its output records from the database and releases
                the batch processing lock.</p>

        </div>

        <div class="section" id="cg_kafka_distributor_node__section_gxq_vl5_pnb"><h2 class="title sectiontitle">Handling of undelivered records</h2>
            
            <p class="p">If CG Kafka Distributor Node cannot deliver records to Apache Kafka brokers, it
                raises an aggregated alert message and forwards the undelivered records to the Log
                distributor stream. The undelivered records are forwarded in ASN.1 format. </p>

            <p class="p">To avoid duplicating records sent to the Log Distributor stream, CG Kafka Distributor
                Node stores per-record flags indicating successful delivery. In a single atomic
                operation, the node checks if the flag already exists in the database and, if not,
                creates a new record together with the corresponding flag. The flags are cleared
                after all the records in the batch have been processed successfully and the data has
                been deleted.</p>

            <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> 
                <p class="p">CG Kafka Distributor Node filters out records with flags before sending the data
                    to Apache Kafka brokers to prevent simultaneous delivery of the records to both
                    Apache Kafka brokers and Log Distributor stream.</p>

            </div>

        </div>

        <div class="section" id="cg_kafka_distributor_node__section_ehp_wtv_s4b"><h2 class="title sectiontitle">Disabling failure logging</h2>
            
            <p class="p">It is possible to disable failure logging, that is, prevent CG Kafka Distributor Node
                from forwarding undelivered records to the Log distributor stream and the Log
                distributor stream from writing the records to the failure log. If failure logging
                is disabled, undelivered records are ignored and an alert is raised.</p>

            <p class="p">Failure logging can be disabled during the installation of NCC by editing the
                    <code class="ph codeph">CustomFailureHandlerClass</code> parameter in the
                    <code class="ph codeph">generic-cdr-streams</code> helm chart. Disabling failure logging means
                that there is no need to install the Log Distributor stream, also defined in the
                helm charts during installation.</p>

        </div>

    </div>
<div class="footer"><hr /><p>Overview Guide • P556766-DN1000054925-R23.8 • 1 • <a href="../home.html">Cover</a> • ©2023 Nokia. Nokia Confidential Information • Use subject to agreed restrictions on disclosure and use.</p></div></body>
</html>