<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta name="copyright" content="(C) Copyright 2023" />
<meta name="DC.rights.owner" content="(C) Copyright 2023" />
<meta name="generator" content="DITA-OT" /><meta name="DC.type" content="concept" />
<meta name="DC.title" content="Database scaling" />
<meta name="DC.relation" scheme="URI" content="sps-status.html" />
<meta name="DC.relation" scheme="URI" content="TPA_heartbeatStatus.html" />
<meta name="DC.relation" scheme="URI" content="db-stats.html" />
<meta name="DC.relation" scheme="URI" content="xdr_status.html" />
<meta name="prodname" content="Nokia Converged Charging" />
<meta name="version" content="Release 23.8" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="database_scaling" />
<link rel="stylesheet" type="text/css" href="../../web/css/commonltr.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/styles.min.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/common-extended.css" /><title>Database scaling</title>
<script src="../web/js/nswtc.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
<script src="../../web/css/../js/script.min.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
</head>
<body id="database_scaling">
<div class="header"><div id="feedback-link-placeholder" class="feedback-link"></div><hr /></div><h1 class="title topictitle1" id="ariaid-title1">Database scaling</h1>
<div class="body conbody">
        <p class="p">Perform this procedure to scale out/in the database. This process should only be
            performed on geo-redundant sites to prevent outages. Each system must be taken off-line
            during the procedure.</p>

        <div class="p">The basic steps are: <ul class="ul">
                <li class="li">Health check</li>

                <li class="li">Mark the system as OOS only for the namespace on which activity is to be
                    done.</li>

                <li class="li">Disable XDR (both incoming and outgoing)</li>

                <li class="li">Pre-verification steps</li>

                <li class="li">Aerospike backup</li>

                <li class="li">Increase database pod count by using Helm commands</li>

                <li class="li">Verification steps</li>

                <li class="li">Enable XDR (both incoming and outgoing)</li>

                <li class="li">Mark system as In-Service</li>

                <li class="li">Post-verification steps </li>

            </ul>
</div>

        <div class="section"><h2 class="title sectiontitle">Health check before scale out</h2>
            
            <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> If any health check fails, you must fix the issue and then proceed with scale
                operations.</div>

            <p class="p">All pod containers must be up and running before you start scaling operations.</p>

            <div class="p">Run these tools on the namespace to verify all pods are up and running: <ul class="ul">
                    <li class="li">sps-status - verify all components are <samp class="ph systemoutput">UP</samp>.</li>

                    <li class="li">network-status - verify all components are
                            <samp class="ph systemoutput">IN_SERVICE</samp>.</li>

                    <li class="li">db-stats</li>

                    <li class="li">xdr-status - verify both <samp class="ph systemoutput">local site towards remote
                            sites</samp> and <samp class="ph systemoutput">remote sites toward local
                            site</samp><p class="p">have sync up state of
                                <samp class="ph systemoutput">CURRENT</samp>.</p>
</li>

                </ul>
</div>

        </div>

        <div class="section"><h2 class="title sectiontitle">Mark the system as OOS for from the admincli pod</h2>
            
            <ol class="ol">
                <li class="li">Verify the count of XDR pods that are running.</li>

                <li class="li">Disable the XDR traffic by scaling the xdr-proxy pods to 0.</li>

                <li class="li">Run this command to disable list the mate site.
                    <pre class="pre codeblock"><code>kubectl -n $NAMESPACE exec -it `kubectl get po -n $NAMESPACE|grep admincli|awk '{print $1}'` -- /opt/tpa/bin/disaster-recovery-helper.py -w</code></pre></li>

                <li class="li">Run this command to remove the forwarder for all mate sites.
                    <pre class="pre codeblock"><code>kubectl -n $NAMESPACE exec -it `kubectl get po -n $NAMESPACE|grep admincli|awk '{print $1}'` -- /opt/tpa/bin/disaster-recovery-helper.py -a remove -s me1</code></pre></li>

                <li class="li">Run this command to view the status of the forwarder.
                    <pre class="pre codeblock"><code>kubectl -n $NAMESPACE exec -it `kubectl get po -n $NAMESPACE|grep admincli|awk '{print $1}'` -- /opt/tpa/bin/disaster-recovery-helper.py -g -s me1</code></pre>
                </li>

            </ol>

        </div>

        <div class="section"><h2 class="title sectiontitle">Pre-verification</h2>
            
            <div class="p">Run these two commands and save the output to compare with the post-scaling ooutput.
                <pre class="pre codeblock"><code>kubectl exec -it -n $NAMESPACE `kubectl get po -n $NAMESPACE|grep admincli |grep '2/2' |awk '{print $1}'|head -n 1 ` -- /opt/tpa/bin/db-stats -c -s all</code></pre></div>

            <pre class="pre codeblock"><code>kubectl -n $NAMESPACE exec -it `kubectl get pods -n $NAMESPACE | grep admincli` -- /opt/aerospike/bin/asadm -e "info"</code></pre>
        </div>

        <div class="section"><h2 class="title sectiontitle">Back up the database</h2>
            
            <div class="p">Run this command to back up the database.
                <pre class="pre codeblock"><code>kubectl exec -it $admincli_pod -c $admincli_ctr -n $_NS -- /opt/tpa/bin/db-backup -f -b false -d /opt/tpa/data/db-backup</code></pre></div>

            <div class="p">Run this command to copy the back up to the home directory.
                <pre class="pre codeblock"><code>kubectl cp $admincli:/opt/tpa/data/ -c $admincli_c -n $_NS $ HOMEDIR</code></pre></div>

            <div class="p">Run this command to verify the back up on the jump server. <pre class="pre codeblock"><code>ls -lart $HOMEDIR/db-backup</code></pre>
                <pre class="pre codeblock"><code>Sample output:
drwxrwxrwx. 1 1024 users 2874 Feb 27 18:10 DB_BACKUP_naperilg27vzwcchf-y-nk-me-001-me-aerospike-rk1-0.me-aerospike-service.naperilg27vzwcchf-y-nk-me-001.svc.cluster.local
drwxrwxrwx. 1 1024 users 2874 Feb 27 18:10 DB_BACKUP_naperilg27vzwcchf-y-nk-me-001-me-aerospike-rk1-1.me-aerospike-service.naperilg27vzwcchf-y-nk-me-001.svc.cluster.local
drwxrwxrwx. 1 1024 users 2874 Feb 27 18:10 DB_BACKUP_naperilg27vzwcchf-y-nk-me-001-me-aerospike-rk2-0.me-aerospike-service.naperilg27vzwcchf-y-nk-me-001.svc.cluster.local
drwxrwxrwx. 1 1024 users 1016 Feb 27 18:10 .
drwxrwxrwx. 1 1024 users 2874 Feb 27 18:10 DB_BACKUP_naperilg27vzwcchf-y-nk-me-001-me-aerospike-rk2-1.me-aerospike-service.naperilg27vzwcchf-y-nk-me-001.svc.cluster.local
drwxrwxrwx. 1 1024 users 3408 Feb 27 19:20 ..</code></pre></div>

        </div>

        <div class="section"><h2 class="title sectiontitle">Scale out procedure for a namespace database</h2>
            
            <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> The Aerospike pod count must be multiple of 2 and not less than 4.</div>

            <ol class="ol">
                <li class="li">Update the replica count to the desired count of Aerospike pods in the override
                    files for Aerospike.</li>

                <li class="li">Run this command to perform a Helm upgrade with new replica counts chart files.
                    <pre class="pre codeblock"><code>helm3 upgrade --install -n &lt;namespace&gt; aerospike &lt;aerospike_chart&gt; -f &lt;Updated_yaml_file_with_Path&gt; --timeout 1200s</code></pre></li>

                <li class="li">Wait for the new pods to come up.</li>

                <li class="li">Run this command to verify the local cluster migration using the admincli pod.
                    <pre class="pre codeblock"><code>kubectl exec -it -n &lt;namespace&gt; `kubectl get po -n &lt;namespace&gt;|grep admincli |awk '{print $1}'|head -n 1 ` -- /opt/tpa/bin/db-stats -v all</code></pre></li>

            </ol>

        </div>

        <div class="section"><h2 class="title sectiontitle">Health check after scale out</h2>
            
            <p class="p">Perform another health check on the system where the database pods scale out was done
                and the system is still in OOS.</p>

            <p class="p">Validate the db-stats and asinfo output with the output taken during
                pre-verification. The data should be distributed on the new node.</p>

        </div>

        <div class="section"><h2 class="title sectiontitle">Mark the system as In-Service</h2>
            
            <ol class="ol">
                <li class="li">Enable XDR after the status is <samp class="ph systemoutput">CURRENT</samp>.</li>

                <li class="li">Run this command to set the replica count to the value it was at the time you
                    disabled XDR. <pre class="pre codeblock"><code>kubectl -n &lt;namespace&gt; scale deploy po-mebcmtru-y-nk-me-000-me-xdrproxy --replicas=1</code></pre>
                    <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> Validate the XDR status should be <samp class="ph systemoutput">CURRENT</samp>
                        before proceeding to the next step.</div>
</li>

                <li class="li">Run this command to enable the XDR forwarder for all of the systems that were
                    previously disabled.
                    <pre class="pre codeblock"><code>kubectl -n $NAMESPACE exec -it `kubectl get po -n $NAMESPACE|grep admincli|awk '{print $1}'` -- /opt/tpa/bin/disaster-recovery-helper.py -x start -s sm1</code></pre>
                </li>

                <li class="li">Run this command to view the status of the forwarder.
                    <pre class="pre codeblock"><code>kubectl -n $NAMESPACE exec -it `kubectl get po -n $NAMESPACE|grep admincli|awk '{print $1}'` -- /opt/tpa/bin/disaster-recovery-helper.py -g -s me1</code></pre>
                </li>

                <li class="li">Mark the system as In-Service.</li>

                <li class="li">Verify that all pods have a status of <samp class="ph systemoutput">UP</samp>.</li>

            </ol>

        </div>

        <div class="section"><h2 class="title sectiontitle">Scale in procedure for a namespace database</h2>
            
            <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> Aerospike does not allow you to reduce the count directly to the desired count.
                You must reduce the count per rack single node to prevent data inconsistency.</div>

            <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> 
                <p class="p">If the system was marked In-Service, then before starting the scale-in activity,
                    repeat the steps for marking the system OOS, disabling XDR, and the
                    pre-verification steps (from Scale out section) before performing these
                    steps.</p>

            </div>

            <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> Scale in can be done only if these two conditions are true: <ul class="ul">
                    <li class="li">Do not scale in below the dimensioned capacity.</li>

                    <li class="li">The free memory displayed in db-stats is less than 50%.</li>

                </ul>
<p class="p">If not, contact your Dimensioning team for assistance.</p>
</div>

            <div class="p"><ol class="ol">
                    <li class="li">Update the replica count to the desired value in the override files for
                        Aerospike.</li>

                    <li class="li">Reduce the count rack by rack. <ol class="ol" type="a">
                            <li class="li">Run this command to reduce the replica count (one by one) for the
                                Rack-1 database node in Statefulset.
                                <pre class="pre codeblock"><code>kubectl -n &lt;namespace&gt; scale sts po-mebcmtru-y-nk-me-000-me-aerospike-rk0 --replicas=&lt;n-1&gt;</code></pre></li>

                            <li class="li">Wait for migration to complete until <code class="ph codeph">db-stats -c -s all |
                                    grep migration</code> returns
                                <samp class="ph systemoutput">YES</samp>.</li>

                            <li class="li">Run this command to reduce the replica count (one by one) for the
                                Rack-2 database node in Statefulset.
                                <pre class="pre codeblock"><code>kubectl -n &lt;namespace&gt; scale sts po-mebcmtru-y-nk-me-000-me-aerospike-rk1 --replicas=&lt;n-1&gt;</code></pre></li>

                            <li class="li">Wait for migration to complete by using <code class="ph codeph">db-stats -c -s all
                                    |grep -i migration</code>.</li>


                            <li class="li">Repeat the steps until the desired replica count is reached.</li>

                        </ol>
</li>

                    <li class="li">Run this command to perform a helm upgrade with the reduced replica counts
                        chart files.
                        <pre class="pre codeblock"><code>helm3 upgrade --install -n &lt;namespace&gt; aerospike &lt;aerospike_chart&gt; -f &lt;Updated_yaml_file_With_Path&gt; --timeout 1200s</code></pre></li>

                    <li class="li">Run this command to verify local cluster migration by using admincli pod.
                        <pre class="pre codeblock"><code>kubectl exec -it -n &lt;namespace&gt; `kubectl get po -n &lt;namespace&gt;|grep admincli |awk '{print $1}'|head -n 1 ` -- /opt/tpa/bin/db-stats -v all</code></pre></li>


                    <li class="li">Remove the PVC and PV of the terminated Aerospike pods.</li>

                    <li class="li">Perform a health check.</li>

                    <li class="li">Mark the system as In-Service.</li>

                </ol>
</div>

        </div>

    </div>
<div class="related-links related-links-title">More on this topic</div><div class="related-links">
<div class="linklist relinfo"><ul class="linklist">
<li class="linklist"><a class="link" href="sps-status.html">sps-status</a></li>
<li class="linklist"><a class="link" href="TPA_heartbeatStatus.html">network-status</a></li>
<li class="linklist"><a class="link" href="db-stats.html">db-stats</a></li>
<li class="linklist"><a class="link" href="xdr_status.html">xdr-status</a></li></ul></div>
</div><div class="footer"><hr /><p>Operations, Administration, and Maintenance Guide • P556766-DN1000055092-R23.8 • 1 • <a href="../home.html">Cover</a> • ©2023 Nokia. Nokia Confidential Information • Use subject to agreed restrictions on disclosure and use.</p></div></body>
</html>