<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta name="copyright" content="(C) Copyright 2023" />
<meta name="DC.rights.owner" content="(C) Copyright 2023" />
<meta name="generator" content="DITA-OT" /><meta name="DC.type" content="concept" />
<meta name="DC.title" content="Proactive clearing of stale Diameter/Nchf_ConvergedCharging sessions" />
<meta name="prodname" content="Nokia Converged Charging" />
<meta name="version" content="Release 23.8" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="clearing_stale_sessions" />
<link rel="stylesheet" type="text/css" href="../../web/css/commonltr.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/styles.min.css" />
<link rel="stylesheet" type="text/css" href="../../web/css/common-extended.css" /><title>Proactive clearing of stale Diameter/Nchf_ConvergedCharging sessions</title>
<script src="../web/js/nswtc.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
<script src="../../web/css/../js/script.min.js" language="javascript" type="text/javascript">/*(◎_◎;)*/</script>
</head>
<body id="clearing_stale_sessions">
<div class="header"><div id="feedback-link-placeholder" class="feedback-link"></div><hr /></div><h1 class="title topictitle1" id="ariaid-title1">Proactive clearing of stale Diameter/Nchf_ConvergedCharging sessions</h1>
<div class="body conbody">
        <p class="p">In NCC, mechanism is available to audit active Diameter and Nchf_ConvergedCharging
            sessions when a configured threshold of active data sessions is reached. Separate
            session limits are available per interface, that is, Ro, Gy, N40. When the audit session
            threshold is reached for an interface, the CHF triggers a RAR for all the previously
            active sessions of the same type, so that the ones for which error/timeout is returned
            from the network can be cleared. In addition, when the audit threshold is reached, any
            new session has a new max limit defined for the validity time (VT) returned to the
            network. This is done to detect cases where the network rapidly creates, and immediately
            abandons, new data sessions due to problems elsewhere in the network. </p>

        <p class="p">NCC also provides the ability to initiate ASR towards the network for terminating the
            least recently used (LRU) session when the <strong class="ph b">Maximum Active Session Limit Per
                Device</strong> is exceeded (separate limits are managed per interface, that is, Ro, Gy,
            N40).
        </p>

        <p class="p">Separate <strong class="ph b">Audit Active Session Limit Per Device</strong>, <strong class="ph b">Maximum VT when Audit Active
                Session Limit Reached</strong>, <strong class="ph b">Maximum Active Session Limit Per Device</strong>, and
                <strong class="ph b">Terminate Failure Audit Timer</strong> can be configured for Ro, Gy, N40. For
            configuring these parameters, refer to section <em class="ph i">Session Management</em> in the
                <em class="ph i">Diameter/HTTP Configuration Guide</em>.</p>

        <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> This feature is applicable for new Gy, Ro, N40 session creation, that is, either via
            CCR-I or via CCR-U (when the application preference <strong class="ph b">New Call Start in Update or
                Terminate</strong> is set to <var class="keyword varname">true</var> and a new session is created in
            CCR-U).</div>

        <div class="section" id="clearing_stale_sessions__section_qb4_z5n_bqb"><h2 class="title sectiontitle">Handling of <var class="keyword varname">Audit Active Session Limit Per Device</var></h2>
            
            <p class="p">For an interface, when the <strong class="ph b">Audit Active Session Limit Per Device</strong> is reached
                during new session creation, NCC triggers RAR/notify message towards the network for
                all the existing sessions of that interface. In addition, NCC returns a successful
                response for the create transaction. However, the VT value for each
                MSCC/MultiUnitInformation is limited to a maximum of the value defined in <strong class="ph b">Maximum
                    VT when Audit Session Limit Reached</strong>.</p>

            <p class="p"> If the RAR/notify is responded by an error/timeout from the network, indicating that
                the sessions are not known to the network, NCC clears that session.</p>

            <p class="p">Also, if a timeout occurs after sending the maximum retries for a notification to the
                network without receiving any successful response from the network, then the session
                is removed from the device. This applies when no response is received on a timeout
                after max retries for routing outbound transactions through a Drouter (see
                    <em class="ph i">Routing outbound 4G transactions through Drouter</em> in the <em class="ph i">Diameter/HTTP
                    Configuration Guide</em>).</p>

            
            <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> 
                <ul class="ul" id="clearing_stale_sessions__ul_atv_wyn_bqb">
                    <li class="li">If for an interface, the <strong class="ph b">Audit Active Session Limit Per Device</strong> is set
                        to 3, the audit is triggered when the third session of that interface is
                        received.</li>

                    <li class="li">The audit is triggered each time a new session establishment request is
                        received after the <strong class="ph b">Audit Active Session Limit Per Device</strong> is
                        crossed.</li>

                    <li class="li">If RAR/notify for existing sessions is in progress during a session
                        establishment, and the device receives another session establishment request
                        on that same interface, then RAR/notify is triggered for only the session
                        for which RAR/notify has not been triggered yet. If RAR/notify for any
                        session is in flight or its <var class="keyword varname">ack</var> is not yet received by
                        NCC, RAR/notify is not sent again.</li>

                </ul>

            </div>

        </div>

        <div class="section" id="clearing_stale_sessions__section_fb2_v5n_bqb"><h2 class="title sectiontitle">Handling of <var class="keyword varname">Maximum Active Session Limit Per Device</var></h2>
            
            <p class="p">When <strong class="ph b">Maximum Active Session Limit Per Device</strong> is already reached for an
                interface during new session creation, NCC identifies the LRU active session to be
                terminated. This is defined as the currently active session which received its last
                transaction from the network least recently. NCC sends an ASR for this session and
                immediately removes the session from the system. The new session is processed
                successfully. When ASA is received for the session, it is silently processed without
                generating any error. When CCR-T is received, since the session no more exists, it
                is responded with an unknown session error.</p>

            <p class="p">If the current number of sessions is at or above the <strong class="ph b">Maximum Active Audit Session
                    Limit Per Device</strong> then NCC also initiates RARs/notifies for all the other
                sessions of the same interface (excluding the newly created session and the session
                sent an ASR for termination).</p>

            <div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> If device has 10 active sessions and we configure the Max Session limit to 5, then
                on CCR-I for the device, we will be sending 5 ASR for LRU active sessions in the
                system.</div>

        </div>

        <div class="section" id="clearing_stale_sessions__section_qgq_2gz_1qb"><h2 class="title sectiontitle">Behavior of <var class="keyword varname">Maximum Active Session Limit
                    Per Device</var> with <var class="keyword varname">Allowed Concurrent Gy sessions per
                    Device</var></h2><p class="p">This section is applicable only for Gy and N40
                sessions.</p>
If the device session limit defined in the application preference
                <strong class="ph b">Allowed Concurrent Gy sessions per Device</strong> (see <a class="xref" href="system_pref.html">Charging application preferences</a>) is reached and if the parameter
                <strong class="ph b">Maximum Active Session Limit Per Device</strong> is: <ul class="ul" id="clearing_stale_sessions__ul_wtr_qkz_1qb">
                <li class="li"><strong class="ph b">Disabled (=0):</strong> The LRU sessions (active or inactive) are deleted.</li>

                <li class="li"><strong class="ph b">Enabled (&gt;0):</strong> The LRU inactive sessions are deleted. For example, if
                        <strong class="ph b">Maximum Active Session Limit Per Device</strong> is set to 5, and <strong class="ph b">Allowed
                        Concurrent Gy sessions per Device</strong> sessions (active and inactive for Gy,
                    and N40) is set to 10, then the following cases may occur: <ul class="ul" id="clearing_stale_sessions__ul_ftr_dtn_bqb">
                        <li class="li">If there are 10 inactive sessions and no active sessions and if a new
                            active Gy session begins, the LRU inactive session is removed from the
                            system. </li>

                        <li class="li">If there are 5 active Gy sessions and 5 inactive sessions and a new
                            sessions starts, then both the LRU active Gy session are terminated. As
                            the terminated Gy session becomes the newest inactive session, the LRU
                            inactive session is also removed.</li>

                    </ul>
</li>

            </ul>
<div class="note"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> It is recommended that for cumulative data sessions <strong class="ph b">Allowed Concurrent Gy
                    Sessions per Device</strong> should be greater than the sum of <strong class="ph b">Maximum Active
                    Session Limit Per Device</strong> (for Gy session) and <strong class="ph b">Maximum Active Session
                    Limit Per Device</strong> (for N40 session). The difference between the maximum
                cumulative data sessions and the sum of the Gy and N40 active session limits is the
                number of inactive data sessions, which is retained even if the maximum number of
                active data sessions is reached.</div>
</div>

        <div class="section" id="clearing_stale_sessions__section_zj2_dgz_1qb"><h2 class="title sectiontitle">Behavior of <var class="keyword varname">Maximum Active Session Limit Per Device</var> with
                    <var class="keyword varname">Time to Live for Terminated Sessions (Seconds)</var></h2>
            
            <div class="p">If <strong class="ph b">Maximum Active Session Limit Per Device</strong> is reached, and if the application
                preference <strong class="ph b">Time to Live for Terminated Sessions (Seconds)</strong> is:<ul class="ul" id="clearing_stale_sessions__ul_zmj_zb1_bqb">
                    <li class="li"><strong class="ph b">Enabled (&gt;0):</strong> ASR is triggered for the LRU active session, and that
                        session is marked as inactive. If a session is marked as inactive after
                        sending ASR, if CCR-U reaches to the OCS before CCR-T, then reservation is
                        not processed for the CCR-U. This CCR-U request is treated as a direct debit
                        request. If CCR-T is received after ASR, the session ID is matched with the
                        information saved when the session was marked inactive (as the
                            <var class="keyword varname">CC-Request-Number</var> is greater than the stored value)
                        all new usage is applied to the subscriptions of the device and the last
                        received USU and <var class="keyword varname">CC-Request-Number</var> are updated in the
                        terminated session database. NCC returns a result code for success in the
                        CCA-T. For more details about terminated sessions, refer to <a class="xref" href="support_for_duplicate_request_handling.html">Duplicate request handling</a>.</li>

                    <li class="li"><strong class="ph b">Disabled (=0):</strong> The session is deleted. </li>

                </ul>
</div>

        </div>

        <div class="section" id="clearing_stale_sessions__section_mgq_3yk_4tb"><h2 class="title sectiontitle">Clearing stale sessions using <em class="ph i">Terminate Failure Audit Timer</em></h2>
            
            <p class="p">If NCC receives a terminate/delete request for any session (Sy, HTTP N28, Ro, Gy,
                N40), and the terminate request returns a success response, then the session is
                removed. </p>

            <p class="p">If the terminate request fails due to some errors (for example:
                    <em class="ph i">DIAMETER_TOO_BUSY</em>, <em class="ph i">UNABLE_TO_COMPLY</em>), then the session accumulates
                in the database. All the sessions, for which terminate request fails, are
                accumulated in the database. These sessions remain in the database until the audit
                removes them. </p>

            <p class="p">This feature provides the functionality to remove the accumulated sessions without a
                long delay. Enabling this feature reduces the time taken by the audit to clear the
                stale sessions. This feature can be enabled for each session separately.</p>

            <p class="p">If this feature is enabled for a session, and a terminate/delete/STR/unsubscribe
                request is received for that session, then the session terminate request is forced
                to return a success response, thereby resulting in session termination.</p>

            <div class="sectiondiv"><strong class="ph b">Configuration</strong><p class="p"><em class="ph i">Terminate Failure Audit Timer</em> attribute in the
                    session management is used to configure this feature. It can be configured for
                    each session (Sy, HTTP N28, Ro, Gy, N40) separately.</p>
<div class="p">This feature is
                    enabled only when <em class="ph i">Terminate Failure Audit Timer</em> is set to a value greater
                    than <var class="keyword varname">0</var>.<div class="note" id="clearing_stale_sessions__note_vp4_rkl_4tb"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> For more details on
                            <em class="ph i">Terminate Failure Audit Timer</em>, see <em class="ph i">Session Management</em> in
                        the <em class="ph i">Diameter/HTTP Configuration Guide</em>.</div>
</div>
<p class="p">If <em class="ph i">Terminate
                        Failure Audit Timer</em> is configured, then the following tasks are
                    performed:</p>
<ul class="ul" id="clearing_stale_sessions__ul_qmb_sbl_4tb">
                    <li class="li">Terminate request returns a success response to the network.</li>

                    <li class="li">Calculate the new audit-entity time (current system time + value of
                            <em class="ph i">Terminate Failure Audit Timer</em> attribute). If the new audit-entity
                        time is less than the earlier expiry time, then the earlier expiry time is
                        replaced with the new audit-entity time.</li>

                    <li class="li">Mark the session inactive.</li>

                </ul>
<div class="p"> The time taken to process or execute the session terminate request to
                    return a response can be configured using the application preference
                        <em class="ph i">Terminate Request Execution Timeout (Milli seconds)</em>.<div class="note" id="clearing_stale_sessions__note_ihg_2gl_4tb"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> For more details on <em class="ph i">Terminate Request Execution
                            Timeout (Milli seconds)</em>, refer to section <em class="ph i">Managed Element
                            application preferences</em> in the <em class="ph i">Global Configuration
                        Guide</em>.</div>
</div>
</div>
            <div class="sectiondiv"><strong class="ph b">Constraints</strong><div class="p">
                    <ul class="ul" id="clearing_stale_sessions__ul_pqj_4fl_4tb">
                        <li class="li">If session termination/delete requests are processed using this feature,
                            then USU in terminate request is not committed, and it is lost.</li>

                        <li class="li">CDR is not generated for processing a terminate session. </li>

                        <li class="li">A CDR is generated only for a success response. <div class="note" id="clearing_stale_sessions__note_hbs_w2l_4tb"><div class="notetitle"><img src="../../web/css/../images/note.svg" title="note-icon" class="noteicon" />Note:</div> The success response does not contain
                                information related to charging units.</div>
</li>

                        <li class="li">This feature is applicable only during the device identification. If the
                            call is stuck after the device identification, then normal call flow is
                            applicable.</li>

                    </ul>

                </div>
</div>
        </div>

        <div class="section" id="clearing_stale_sessions__section_pp4_gf4_bqb"><h2 class="title sectiontitle">CDR changes</h2>
            
            <p class="p">Refer to section <cite class="cite">Session audit CDRs</cite> in the <cite class="cite">CDR/EDR
                    Reference</cite>.</p>

        </div>

        <div class="section" id="clearing_stale_sessions__section_ak2_324_bqb"><h2 class="title sectiontitle">Metrics changes</h2>
            
            <p class="p">Refer to the <cite class="cite">Metrics Spreadsheet</cite>.</p>

        </div>

    </div>
<div class="footer"><hr /><p>Charging User Guide • P556766-DN1000054947-R23.8 • 1 • <a href="../home.html">Cover</a> • ©2023 Nokia. Nokia Confidential Information • Use subject to agreed restrictions on disclosure and use.</p></div></body>
</html>